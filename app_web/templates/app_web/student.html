{% extends 'app_web/components/base.html' %} 
{% load static %}

{% block css %}
<!-- <link rel="stylesheet" type="text/css" href="{% static 'css/student-style.css' %}"> -->
{% endblock %}

{% block title %}Student list{% endblock %} 

{% block body %}
<style>
    #left-column:hover .school-name {
        opacity: 1;
        max-width: 200px; /* Reveal width */
    }

    .school-button img {
        filter: drop-shadow(0 0 8px rgba(56, 189, 248, 0.8)); /* A vibrant sky-blue glow */
    }
    .school-button:hover img {
        transform: scale(1.1); /* Slightly enlarge the logo for emphasis */
    }


    #main-grid {
        display: grid;
        /* Initial state: narrow sidebar, rest of space for content */
        grid-template-columns: 6rem 1fr; /* 6rem = w-24 */
        transition: grid-template-columns 300ms ease-in-out;

        &.sidebar-expanded {
            /* Expanded state: wider sidebar */
            grid-template-columns: 16rem 1fr;
        }
    }

</style>

<div class="relative min-h-screen w-full bg-black antialiased text-white overflow-hidden">
    
    <!-- FIXED BACKGROUND -->
    <div class="fixed inset-0 z-0">
        <img src="{% static 'images/web/background.png' %}" alt="Background" class="object-cover w-full h-full opacity-30 filter blur-sm">
        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent"></div>
    </div>

    <!-- MAIN CONTENT GRID -->
    <div id="main-grid" class="absolute top-20 left-0 right-0" style="height: calc(100vh - 5rem);">

        <!-- =============================================================== -->
        <!-- LEFT COLUMN: SCHOOL SELECTION (FIXED)                           -->
        <!-- =============================================================== -->
        <div id="left-column" class="relative z-50 bg-black/60 backdrop-blur-sm border-r border-gray-800 p-3 flex flex-col gap-y-3 transition-all duration-300 ease-in-out overflow-hidden">
            {% for data in schools_with_students %}
                <button
                    class="school-button w-full p-2 rounded-lg flex items-center transition-colors duration-300 ease-in-out bg-gray-600/80 hover:bg-sky-600/70
                           {% if forloop.first %}active ring-2 ring-sky-400{% endif %}"
                    data-school-id="{{ data.school.school_id }}">
                    
                    <img src="{% url 'serve_school_image' school_id=data.school.school_id %}" alt="{{ data.school.school_name }} Logo" class="h-12 w-12 pl-1 object-contain flex-shrink-0 transition-all duration-300">
                    
                    <span class="school-name ml-3 font-bold text-lg whitespace-nowrap overflow-hidden transition-all duration-300 ease-in-out opacity-0 max-w-0">
                        {{ data.school.school_name }}
                    </span>
                </button>
            {% endfor %}
        </div>

        <!-- =============================================================== -->
        <!-- RIGHT COLUMN: CHARACTER DISPLAY (OVERHAULED)                    -->
        <!-- =============================================================== -->
        <div id="right-column" class="h-full relative overflow-hidden">
            {% for data in schools_with_students %}
            <div id="school-group-{{ data.school.school_id }}"
                 class="character-group absolute inset-0 transition-opacity duration-500 ease-in-out {% if not forloop.first %}opacity-0 pointer-events-none{% endif %}">

                <div class="slider-container absolute top-0 left-0 w-full h-full flex items-center">
                    {% for student in data.students %}
                    <div class="character-card flex-shrink-0 w-[300px] h-[85%] mx-4 transition-all duration-500 ease-in-out">
                         <div class="relative w-full h-full group">
                            <img src="{% url 'serve_student_image' student_id=student.student_id image_type='portrait' %}" alt="{{ student.student_name }}" class="w-full h-full object-cover rounded-lg">
                             <div class="character-name absolute bottom-[20px] left-[70px] opacity-0 transition-all duration-500 ease-in-out transform -translate-x-8">
                                 <h2 class="text-5xl font-black text-white uppercase tracking-widest origin-bottom-left transform -rotate-90" 
                                     style="text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.7);">
                                     {{ student.student_name }}
                                 </h2>
                             </div>
                         </div>
                    </div>
                    {% endfor %}
                </div>

                <button class="nav-arrow nav-left absolute left-6 top-1/2 -translate-y-1/2 bg-black/40 p-3 rounded-full hover:bg-sky-500/50 transition-colors z-40">
                    <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <button class="nav-arrow nav-right absolute right-6 top-1/2 -translate-y-1/2 bg-black/40 p-3 rounded-full hover:bg-sky-500/50 transition-colors z-40">
                    <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
            {% endfor %}
        </div>

    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const mainGrid = document.getElementById('main-grid');
    const leftColumn = document.getElementById('left-column');

    let activeGroupId = document.querySelector('.character-group:not(.opacity-0)')?.id;
    
    // A variable to hold the ID of our animation loop
    let animationFrameId = null;
    
    // --- 1. PERFECTLY SYNCHRONIZED SIDEBAR EXPANSION ---
    function recenterActiveCarouselInstantly() {
        if (activeGroupId) {
            const activeGroupElement = document.getElementById(activeGroupId);
            if (activeGroupElement) {
                // We always call with 'true' for an instant, frame-by-frame update.
                updateCarousel(activeGroupElement, true);
            }
        }
    }

    function startAnimationLoop() {
        // Cancel any previous loop to prevent conflicts
        if (animationFrameId) cancelAnimationFrame(animationFrameId);

        const animationDuration = 300; // Must match the CSS transition duration
        let startTime = null;

        const loop = (currentTime) => {
            if (!startTime) startTime = currentTime;
            const elapsedTime = currentTime - startTime;

            recenterActiveCarouselInstantly();

            if (elapsedTime < animationDuration) {
                // If the animation is not finished, request the next frame
                animationFrameId = requestAnimationFrame(loop);
            } else {
                 // Final check to ensure it lands perfectly
                 recenterActiveCarouselInstantly();
            }
        };

        // Start the loop
        animationFrameId = requestAnimationFrame(loop);
    }

    leftColumn.addEventListener('mouseenter', () => {
        mainGrid.classList.add('sidebar-expanded');
        startAnimationLoop();
    });

    leftColumn.addEventListener('mouseleave', () => {
        mainGrid.classList.remove('sidebar-expanded');
        startAnimationLoop();
    });

    // --- 2. ADVANCED SEAMLESS CAROUSEL LOGIC ---
    const carouselState = {};
    const CLONE_COUNT = 3; // Number of items to clone on each side for the seamless effect

    function updateCarousel(group, instant = false) {
        const slider = group.querySelector('.slider-container');
        const state = carouselState[group.id];

        slider.style.transitionDuration = instant ? '0ms' : '300ms';
        slider.style.transitionTimingFunction = instant ? '' : 'ease-in-out';
        
        const containerWidth = group.offsetWidth;
        const cardWidth = state.cards[0].offsetWidth;
        const margin = parseInt(window.getComputedStyle(state.cards[0]).marginRight) * 2;
        const cardAndMarginWidth = cardWidth + margin;
        
        const offsetToCenter = (containerWidth / 2) - (cardAndMarginWidth / 2);
        const newX = offsetToCenter - (state.currentIndex * cardAndMarginWidth);
        
        slider.style.transform = `translateX(${newX}px)`;

        state.cards.forEach((card, i) => {
            const nameElement = card.querySelector('.character-name');
            // We use the 'realIndex' to correctly identify the active card, ignoring clones
            const realIndex = (state.currentIndex - CLONE_COUNT + state.totalRealCards) % state.totalRealCards;
            const cardRealIndex = parseInt(card.dataset.realIndex);

            if (realIndex === cardRealIndex) {
                card.style.transform = 'scale(1.15)'; 
                card.style.opacity = '1';
                card.classList.remove('grayscale');
                nameElement.classList.remove('opacity-0', '-translate-x-8');
                nameElement.classList.add('opacity-100', 'translate-x-0');
            } else {
                card.style.transform = 'scale(0.9)';
                card.style.opacity = '0.5';
                card.classList.add('grayscale');
                nameElement.classList.remove('opacity-100', 'translate-x-0');
                nameElement.classList.add('opacity-0', '-translate-x-8');
            }
        });
    }

    // --- Setup logic for each carousel ---
    document.querySelectorAll('.character-group').forEach(group => {
        const slider = group.querySelector('.slider-container');
        const originalCards = Array.from(group.querySelectorAll('.character-card'));
        const totalRealCards = originalCards.length;
        if (totalRealCards === 0) return;

        // Assign a real index to each original card for later identification
        originalCards.forEach((card, i) => card.dataset.realIndex = i);

        // Cloning for seamless effect
        const clonesStart = originalCards.slice(-CLONE_COUNT).map(c => c.cloneNode(true));
        const clonesEnd = originalCards.slice(0, CLONE_COUNT).map(c => c.cloneNode(true));
        
        slider.append(...clonesEnd);
        slider.prepend(...clonesStart);

        const allCards = Array.from(slider.querySelectorAll('.character-card'));

        carouselState[group.id] = {
            currentIndex: CLONE_COUNT, // Start at the first "real" item
            totalRealCards: totalRealCards,
            cards: allCards,
            isTransitioning: false
        };

        setTimeout(() => updateCarousel(group, true), 100);

        // --- Event Listeners for seamless looping ---
        group.querySelector('.nav-left')?.addEventListener('click', () => {
            const state = carouselState[group.id];
            if (state.isTransitioning) return;
            state.currentIndex--;
            updateCarousel(group);
            state.isTransitioning = true;
        });

        group.querySelector('.nav-right')?.addEventListener('click', () => {
            const state = carouselState[group.id];
            if (state.isTransitioning) return;
            state.currentIndex++;
            updateCarousel(group);
            state.isTransitioning = true;
        });

        // The magic happens here: check for clones after transition ends
        slider.addEventListener('transitionend', () => {
            const state = carouselState[group.id];
            state.isTransitioning = false;
            
            // If we are on a clone at the end, jump to the first real item
            if (state.currentIndex >= state.totalRealCards + CLONE_COUNT) {
                state.currentIndex = CLONE_COUNT;
                updateCarousel(group, true);
            }
            // If we are on a clone at the start, jump to the last real item
            if (state.currentIndex < CLONE_COUNT) {
                state.currentIndex = state.totalRealCards + CLONE_COUNT - 1;
                updateCarousel(group, true);
            }
        });
    });

    // --- 3. SCHOOL SELECTION ---
    const schoolSelectors = document.querySelectorAll('.school-button');

    schoolSelectors.forEach(button => {
        button.addEventListener('click', () => {
            const schoolId = button.dataset.schoolId;
            const newGroupId = `school-group-${schoolId}`;
            if (newGroupId === activeGroupId) return;

            schoolSelectors.forEach(btn => btn.classList.remove('active', 'ring-2', 'ring-sky-400'));
            button.classList.add('active', 'ring-2', 'ring-sky-400');
            
            const oldGroup = document.getElementById(activeGroupId);
            if (oldGroup) oldGroup.classList.add('opacity-0', 'pointer-events-none');

            const newGroup = document.getElementById(newGroupId);
            if (newGroup) {
                newGroup.classList.remove('opacity-0', 'pointer-events-none');
                updateCarousel(newGroup, true);
                
                // This is the only update needed. The string ID is our "source of truth".
                activeGroupId = newGroupId; 
            }
        });
    });
    
    window.addEventListener('resize', () => {
        if (activeGroupId) updateCarousel(document.getElementById(activeGroupId), true);
    });
});
</script>
{% endblock %}

{% block js %}
<!-- <script defer src="{% static 'js/students.js' %}"></script> -->
 
{% endblock %}