{% extends 'app_web/components/base.html' %} 
{% load static %}

{% block css %}
<!-- <link rel="stylesheet" type="text/css" href="{% static 'css/student-style.css' %}"> -->
{% endblock %}

{% block title %}Student list{% endblock %} 

{% block body %}
<style>
    /* 
    FIXED: Left column name now only reveals on direct hover of a button 
    or when it's the active selection. This is more intuitive.
    */
    .school-button:hover .school-name,
    .school-button.active .school-name {
        opacity: 1;
        max-width: 200px; /* Reveal width */
        transform: translateX(0);
        margin-left: 0.75rem; /* 12px */
    }
</style>

<div class="relative min-h-screen w-full bg-black antialiased text-white overflow-hidden">
    <!-- FIXED BACKGROUND -->
    <div class="fixed inset-0 z-0">
        <img src="{% static 'images/web/background.png' %}" alt="Background" class="object-cover w-full h-full opacity-30 filter blur-sm">
        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent"></div>
    </div>

    <!-- MAIN CONTENT GRID -->
    <div class="relative z-10 grid grid-cols-12 h-screen">

        <!-- =============================================================== -->
        <!-- LEFT COLUMN: SCHOOL SELECTION (FIXED)                           -->
        <!-- =============================================================== -->
        <div class="col-span-2 lg:col-span-1 bg-black/60 backdrop-blur-sm border-r border-gray-800 p-4 flex flex-col items-start gap-y-3 transition-all duration-300 ease-in-out">
            {% for data in schools_with_students %}
                <button
                    class="school-button w-full p-2 rounded-lg flex items-center transition-colors duration-300 ease-in-out bg-slate-800/70 hover:bg-slate-700/90
                           {% if forloop.first %}active{% endif %}"
                    data-school-id="{{ data.school.school_id }}">
                    
                    <img src="{% url 'serve_school_image' school_id=data.school.school_id %}" alt="{{ data.school.school_name }} Logo" class="h-14 w-14 object-contain flex-shrink-0">
                    
                    <span class="school-name font-bold text-lg whitespace-nowrap overflow-hidden transition-all duration-300 ease-in-out opacity-0 max-w-0 transform -translate-x-4">
                        {{ data.school.school_name }}
                    </span>
                </button>
            {% endfor %}
        </div>


        <!-- =============================================================== -->
        <!-- RIGHT COLUMN: CHARACTER DISPLAY (OVERHAULED)                    -->
        <!-- =============================================================== -->
        <div class="col-span-10 lg:col-span-11 h-full relative overflow-hidden">
            {% for data in schools_with_students %}
            <div id="school-group-{{ data.school.school_id }}"
                 class="character-group absolute inset-0 transition-opacity duration-500 ease-in-out {% if not forloop.first %}opacity-0 pointer-events-none{% endif %}">

                <!-- This new slider div will contain all cards in a row and will be moved -->
                <div class="slider-container absolute top-0 left-0 w-full h-full flex items-center transition-transform duration-500 ease-in-out">
                    {% for student in data.students %}
                    <div class="character-card flex-shrink-0 w-[20%] h-[85%] mx-2 transition-all duration-500 ease-in-out">
                         <div class="relative w-full h-full">
                            <img src="{% url 'serve_student_image' student_id=student.student_id image_type='portrait' %}"
                                 alt="{{ student.student_name }}"
                                 class="w-full h-full object-cover rounded-lg">
                             
                             <div class="character-name absolute -bottom-4 left-1/2 -translate-x-1/2 w-auto whitespace-nowrap opacity-0 transition-all duration-300 ease-in-out">
                                 <p class="text-3xl font-bold bg-black/50 py-2 px-6 rounded-md">{{ student.student_name }}</p>
                             </div>
                         </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Navigation -->
                <button class="nav-arrow nav-left absolute left-4 top-1/2 -translate-y-1/2 bg-black/40 p-3 rounded-full hover:bg-sky-500/50 transition-colors z-40">
                    <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <button class="nav-arrow nav-right absolute right-4 top-1/2 -translate-y-1/2 bg-black/40 p-3 rounded-full hover:bg-sky-500/50 transition-colors z-40">
                    <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const carouselState = {};

    function updateCarousel(groupId, instant = false) {
        const group = document.getElementById(groupId);
        if (!group) return;

        const slider = group.querySelector('.slider-container');
        const cards = group.querySelectorAll('.character-card');
        const total = cards.length;
        if (total === 0) return;

        if (!carouselState[groupId]) {
            carouselState[groupId] = { currentIndex: 0 };
        }
        let currentIndex = carouselState[groupId].currentIndex;

        // --- 1. FLAT, SIDE-BY-SIDE LAYOUT LOGIC ---
        // We calculate the position needed to center the active card.
        // The entire slider moves, not the individual cards.
        const containerWidth = group.offsetWidth;
        const cardWidth = cards[0].offsetWidth;
        const margin = parseInt(window.getComputedStyle(cards[0]).marginRight) * 2; // Approximating margin space
        const cardAndMarginWidth = cardWidth + margin;
        
        // Calculate the translation to center the current card
        const offsetToCenter = (containerWidth / 2) - (cardAndMarginWidth / 2);
        const newX = offsetToCenter - (currentIndex * cardAndMarginWidth);
        
        slider.style.transitionDuration = instant ? '0ms' : '500ms';
        slider.style.transform = `translateX(${newX}px)`;

        // --- 2. STYLE CARDS (ACTIVE vs INACTIVE) ---
        cards.forEach((card, i) => {
            const nameElement = card.querySelector('.character-name');
            if (i === currentIndex) {
                // Active Card
                card.style.transform = 'scale(1.05)';
                card.style.opacity = '1';
                nameElement.classList.remove('opacity-0', '-bottom-4');
                nameElement.classList.add('opacity-100', 'bottom-8');
            } else {
                // Inactive Cards
                card.style.transform = 'scale(0.9)';
                card.style.opacity = '0.6';
                nameElement.classList.remove('opacity-100', 'bottom-8');
                nameElement.classList.add('opacity-0', '-bottom-4');
            }
        });

        const navLeft = group.querySelector('.nav-left');
        const navRight = group.querySelector('.nav-right');
        if (navLeft) navLeft.style.display = currentIndex > 0 ? 'block' : 'none';
        if (navRight) navRight.style.display = currentIndex < total - 1 ? 'block' : 'none';
    }

    // Initialize all carousels
    document.querySelectorAll('.character-group').forEach(group => {
        const groupId = group.id;
        // A small delay to ensure correct width calculations after render
        setTimeout(() => updateCarousel(groupId, true), 100);

        group.querySelector('.nav-left')?.addEventListener('click', () => {
            if (carouselState[groupId].currentIndex > 0) {
                carouselState[groupId].currentIndex--;
                updateCarousel(groupId);
            }
        });

        group.querySelector('.nav-right')?.addEventListener('click', () => {
            const total = group.querySelectorAll('.character-card').length;
            if (carouselState[groupId].currentIndex < total - 1) {
                carouselState[groupId].currentIndex++;
                updateCarousel(groupId);
            }
        });
    });

    // Handle School Selection
    const schoolSelectors = document.querySelectorAll('.school-button');
    let activeGroupId = document.querySelector('.character-group:not(.opacity-0)')?.id;

    schoolSelectors.forEach(button => {
        button.addEventListener('click', () => {
            const schoolId = button.dataset.schoolId;
            const newGroupId = `school-group-${schoolId}`;

            if (newGroupId === activeGroupId) return;

            schoolSelectors.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            const oldGroup = document.getElementById(activeGroupId);
            if (oldGroup) oldGroup.classList.add('opacity-0', 'pointer-events-none');

            const newGroup = document.getElementById(newGroupId);
            if (newGroup) {
                updateCarousel(newGroupId, true);
                newGroup.classList.remove('opacity-0', 'pointer-events-none');
                activeGroupId = newGroupId;
            }
        });
    });
    
    // Recalculate on resize to maintain centering
    window.addEventListener('resize', () => {
        if(activeGroupId) {
            updateCarousel(activeGroupId, true);
        }
    });
});
</script>
{% endblock %}

{% block js %}
<!-- <script defer src="{% static 'js/students.js' %}"></script> -->
 
{% endblock %}