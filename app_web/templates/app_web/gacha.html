{% extends 'app_web/components/base.html' %} 
{% load static %}

{% block css %}
{% endblock %}

{% block title %}Gacha{% endblock %} 

{% block body %}
<div class="relative min-h-screen w-full bg-black antialiased text-white overflow-hidden">
    
    <!-- =============================================================== -->
    <!-- PAGE BACKGROUND                                                 -->
    <!-- =============================================================== -->
    
    {% include 'app_web/components/background.html' %}

    <!-- Main Content Container (Adds margins) -->
    <div class="w-full max-w-screen mx-auto px-4 lg:px-6 pt-20">
        
        <!-- This is the main grid for the page layout. -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" style="height: calc(100vh - 7rem);">

            <!-- =============================================================== -->
            <!-- LEFT COLUMN: HERO PREVIEW                                       -->
            <!-- =============================================================== -->
            <div id="hero-section" class="relative w-full h-full bg-slate-900 border border-slate-700 rounded-lg shadow-2xl overflow-hidden">
                <img id="hero-image" src="" alt="Banner Preview" class="absolute inset-0 w-full h-full object-cover z-0 transition-opacity duration-500 opacity-0">
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent z-10"></div>
                <div id="hero-banner-name" class="absolute bottom-0 left-0 p-6 z-20 text-5xl font-black text-white uppercase tracking-widest opacity-0 transition-all duration-500 transform translate-y-4" style="text-shadow: 2px 2px 10px rgba(0,0,0,0.7);"></div>
            </div>

            <!-- =============================================================== -->
            <!-- RIGHT COLUMN: INTERACTION PANEL                                 -->
            <!-- =============================================================== -->
            <div class="w-full h-full grid grid-rows-5 gap-6">
                
                <!-- Upper Row (2/5 height): Banner Carousel -->
                <div id="banner-carousel" class="relative row-span-2 w-full h-full overflow-hidden">
                    {% for banner in banners %}
                    <div class="banner-card absolute top-1/2 left-1/2 h-full w-[100%] transition-all duration-500 ease-in-out rounded-lg overflow-hidden cursor-pointer"
                         data-index="{{ forloop.counter0 }}"
                         data-banner-id="{{ banner.banner_id }}"
                         data-name="{{ banner.banner_name }}"
                         data-hero-image-url=""
                    >
                        <!-- <img src="{% url 'serve_banner_image' banner_id=banner.banner_id %}" class="w-full h-full object-contain"> -->
                        <!-- MODIFIED: Wrapped the image in a div for easier grayscale control -->
                        <div class="card-image-wrapper w-full h-full">
                            <img src="{% url 'serve_banner_image' banner_id=banner.banner_id %}" class="w-full h-full object-contain">
                        </div>
                    </div>
                    {% endfor %}
                    <!-- Navigation Arrows -->
                    <button class="nav-arrow nav-left absolute left-6 bottom-0 bg-black/40 p-3 rounded-full hover:bg-sky-500/50 transition-colors z-40">
                        <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    <button class="nav-arrow nav-right absolute right-6 bottom-0 bg-black/40 p-3 rounded-full hover:bg-sky-500/50 transition-colors z-40">
                        <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </button>

                    <!-- NEW: Index Indicator Dots -->
                    <div id="indicator-dots" class="absolute bottom-0 left-1/2 -translate-x-1/2 flex gap-2 z-20">
                        {% for banner in banners %}
                        <div class="indicator-dot w-2 h-2 bg-white/30 rounded-full transition-all duration-300" data-index="{{ forloop.counter0 }}"></div>
                        {% endfor %}
                    </div>
                
                </div>

                <!-- Lower Row (3/5 height): Action Panel -->
                <div class="row-span-3 w-full h-full bg-black/30 backdrop-blur-sm border border-slate-700 rounded-lg p-6 flex items-center justify-between">
                    <div class="flex flex-col gap-4">
                        <button id="details-button" class="px-6 py-3 text-lg font-semibold border-2 border-slate-500 hover:border-cyan-400 hover:text-cyan-400 rounded-lg transition-colors">Banner Details</button>
                        <div class="text-center">
                            <div class="text-4xl font-bold text-white">0<span class="text-2xl font-normal text-slate-400"> / 200</span></div>
                            <div class="text-sm text-slate-400 tracking-widest">PITY PULLS</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex flex-col items-center gap-1">
                            <button class="w-32 px-4 py-3 flex justify-center bg-slate-600 hover:bg-slate-500 rounded-lg text-xl font-bold transition-colors">PULL x1</button>
                            <span class="text-sm text-slate-400">120 Pyroxene</span>
                        </div>
                        <div class="flex flex-col items-center gap-1">
                            <button class="w-32 px-4 py-3 flex justify-center bg-cyan-600 hover:bg-cyan-500 rounded-lg text-xl font-bold transition-colors">PULL x10</button>
                            <span class="text-sm text-slate-400">1200 Pyroxene</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Details Modal (Initially hidden) -->
    <div id="details-modal-wrapper" class="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 hidden">
        <div id="details-modal-panel" class="relative w-full max-w-4xl h-[80vh] bg-slate-800 border border-slate-600 rounded-lg shadow-2xl transform scale-95 opacity-0 transition-all duration-300">
            <button id="details-modal-close" class="absolute top-2 right-2 text-slate-400 hover:text-white z-10 text-4xl leading-none">&times;</button>
            <div id="details-modal-content" class="w-full h-full"></div>
        </div>
    </div>

</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Get references to all key elements ---
    const heroImage = document.getElementById('hero-image');
    const heroBannerName = document.getElementById('hero-banner-name');
    const carousel = document.getElementById('banner-carousel');
    const cards = Array.from(carousel.querySelectorAll('.banner-card'));
    const totalCards = cards.length;
    let currentIndex = 0;

    // NEW: Get reference to the indicator dots
    const indicatorDots = Array.from(carousel.querySelectorAll('.indicator-dot'));

    // --- Modal Logic ---
    const detailsButton = document.getElementById('details-button');
    const modalWrapper = document.getElementById('details-modal-wrapper');
    const modalPanel = document.getElementById('details-modal-panel');
    const modalContent = document.getElementById('details-modal-content');
    const modalClose = document.getElementById('details-modal-close');

    async function showDetailsModal() {
        const activeCard = carousel.querySelector(`.banner-card[data-index='${currentIndex}']`);
        if (!activeCard) return;

        modalWrapper.classList.remove('hidden');
        setTimeout(() => modalPanel.classList.remove('scale-95', 'opacity-0'), 10);
        modalContent.innerHTML = `<div class="w-full h-full flex items-center justify-center"><svg class="animate-spin h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg></div>`;

        try {
            const bannerId = activeCard.dataset.bannerId;
            const response = await fetch(`/banner-details/${bannerId}/`);
            if (!response.ok) throw new Error('Failed to load details');
            modalContent.innerHTML = await response.text();
        } catch (error) {
            modalContent.innerHTML = `<p class="text-center text-red-400">${error.message}</p>`;
        }
    }

    function hideDetailsModal() {
        modalPanel.classList.add('scale-95', 'opacity-0');
        setTimeout(() => modalWrapper.classList.add('hidden'), 300);
    }
    
    detailsButton.addEventListener('click', showDetailsModal);
    modalClose.addEventListener('click', hideDetailsModal);
    modalWrapper.addEventListener('click', (e) => { if (e.target === modalWrapper) hideDetailsModal(); });

    // --- Main Carousel & Hero View Logic ---
    function updateHeroView() {
        const activeCard = carousel.querySelector(`.banner-card[data-index='${currentIndex}']`);
        if (!activeCard) return;

        heroBannerName.classList.add('opacity-0', 'translate-y-4');
        heroImage.classList.add('opacity-0');

        setTimeout(() => {
            heroBannerName.textContent = activeCard.dataset.name;
            heroImage.src = activeCard.dataset.heroImageUrl || '';
            heroBannerName.classList.remove('opacity-0', 'translate-y-4');
            heroImage.classList.remove('opacity-0');
        }, 300);
    }

    function updateCarousel() {
        // --- THE RESPONSIVE FIX ---
        // 1. Define the breakpoint. 1024px is the default for Tailwind's 'lg'.
        const DESKTOP_BREAKPOINT = 1024;
        const isDesktop = window.innerWidth >= DESKTOP_BREAKPOINT;

        // 2. Choose different layout values based on the screen size.
        // On desktop, we want a wider gap. On mobile, a much smaller gap.
        const gapMultiplier = isDesktop ? 65 : 30;
        // On mobile, the inactive cards should be smaller to look less crowded.
        const inactiveScale = isDesktop ? 0.7 : 0.6;

        cards.forEach((card, i) => {
            const offset = i - currentIndex;
            const loopedOffset = (offset + totalCards + Math.floor(totalCards / 2)) % totalCards - Math.floor(totalCards / 2);

            const scale = loopedOffset === 0 ? 1.0 : inactiveScale;
            // 3. Use the new adaptive gapMultiplier.
            const translateX = loopedOffset * gapMultiplier;
            const opacity = Math.abs(loopedOffset) > 1 ? 0 : 1;
            const zIndex = totalCards - Math.abs(loopedOffset);

            card.style.transform = `translateY(-50%) translateX(calc(-50% + ${translateX}%)) scale(${scale})`;
            card.style.opacity = opacity;
            card.style.zIndex = zIndex;

            // Grayscale Logic (unchanged)
            const imageWrapper = card.querySelector('.card-image-wrapper');
            if (loopedOffset === 0) {
                imageWrapper.classList.remove('grayscale');
            } else {
                imageWrapper.classList.add('grayscale');
            }
        });

        // Indicator Dots Logic (unchanged)
        indicatorDots.forEach((dot, i) => {
            if (i === currentIndex) {
                dot.classList.add('bg-white');
                dot.classList.remove('bg-white/30');
            } else {
                dot.classList.remove('bg-white');
                dot.classList.add('bg-white/30');
            }
        });

        updateHeroView();
    }

    // --- Event Listeners ---
    carousel.querySelector('.nav-left')?.addEventListener('click', () => {
        currentIndex = (currentIndex - 1 + totalCards) % totalCards;
        updateCarousel();
    });
    carousel.querySelector('.nav-right')?.addEventListener('click', () => {
        currentIndex = (currentIndex + 1) % totalCards;
        updateCarousel();
    });
    cards.forEach(card => {
        card.addEventListener('click', () => {
            currentIndex = parseInt(card.dataset.index);
            updateCarousel();
        });
    });
    window.addEventListener('resize', updateCarousel); // Re-center on resize

    // --- Initial Load ---
    updateCarousel();
});
</script>
{% endblock %}
