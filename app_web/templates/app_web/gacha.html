{% extends 'app_web/components/base.html' %} 
{% load static %}

{% block css %}
{% endblock %}

{% block title %}Gacha{% endblock %} 

{% block body %}
<style>
    /* 1. NEW: THE RING WAVE EFFECT */
    .ring-wave-effect {
        position: absolute;
        border-radius: 50%;
        opacity: 1;
        pointer-events: none;
        aspect-ratio: 1 / 1;
        animation: ring-wave-anim 0.75s ease-out forwards;
        z-index: -1;
    }
    @keyframes ring-wave-anim {
        0% {
            width: 0%;
            opacity: 1;
            /* 
              MODIFIED: The spread values are now much larger, creating a "fattier" ring.
              The inner pink ring is 15px thick.
              The outer cyan ring is an additional 10px thick.
            */
            box-shadow: 0 0 0 10px rgba(244, 114, 182, 0.9), /* Pink */
                0 0 0 20px rgba(192, 132, 252, 0.8), /* Purple */
                0 0 0 25px rgba(56, 189, 248, 0.7);  /* Cyan */
        }
        100% {
            width: 40%;
            opacity: 1;
            /* Also update the final state for consistency. */
            box-shadow: 0 0 0 8px rgba(244, 114, 182, 0),
                0 0 0 16px rgba(192, 132, 252, 0),
                0 0 0 24px rgba(56, 189, 248, 0);
        }
    }

    /* 
      The .card-shine-overlay is a container for the shine pseudo-element.
      It's clipped by its parent's shape.
    */
    .card-shine-overlay {
        position: absolute;
        inset: 0;
        overflow: hidden;
    }

    /*
      The ::before pseudo-element is the shine itself.
      It's a tall, diagonal bar of light that starts off-screen.
    */
    .card-shine-overlay::before {
        content: '';
        position: absolute;
        top: -150%;
        left: -150%;
        width: 60px; /* How thick the shine is */
        height: 400%;
        background: linear-gradient(
            to right,
            transparent 0%,
            rgba(255, 255, 255, 0.5) 50%,
            transparent 100%
        );
        transform: rotate(-45deg);
        opacity: 0;
    }

    /* When the card is flipped, the shine animation is triggered. */
    .is-flipped .card-shine-overlay::before {
        animation: card-shine-anim 0.7s ease-in-out;
        /* The delay ensures the shine happens AFTER the card has flipped forward. */
        animation-delay: 0.2s; 
    }

    @keyframes card-shine-anim {
        0% {
            left: -150%; /* Start far to the left */
            opacity: 1;
        }
        100% {
            left: 150%; /* End far to the right */
            opacity: 1;
        }
    }

    /* 2. UPDATED: SPARKLE EFFECT */
    .sparkle {
        position: absolute;
        width: 20px;
        height: 20px;
        
        /* The parent div is now a flex container to center the character. */
        display: flex;
        align-items: center;
        justify-content: center;

        opacity: 0;
        transform: scale(0);
        transition: transform 0.5s ease-out, opacity 0.5s ease-out;
    }

    /* 
      The ::before pseudo-element IS the sparkle.
      We use a simple star character '✦' as the content.
    */
    .sparkle::before {
        /* You can use other characters like '✦', '✧', '✨', or '★' */
        content: '✦'; 
        font-size: 32px;
        color: white;

        /* 
          THE FIX: 'text-shadow' is shape-aware for text characters,
          just like 'filter: drop-shadow' is for shapes. This creates the glow.
        */
        text-shadow: 0 0 5px #fff, 0 0 10px #f0f, 0 0 15px #0ff;
    }
    
    .sparkle.animate {
        transform: scale(1.5) rotate(90deg);
        opacity: 1;
    }
    .sparkle.fade {
        transform: scale(0) rotate(180deg);
        opacity: 0;
    }

    /* 3. SUSTAINED: The Afterglow */
    .is-flipped .afterglow {
        animation: afterglow-anim 1s infinite linear;
    }
    
    @keyframes afterglow-anim {
        0%   { box-shadow: 0 0 25px 8px rgba(56, 189, 248, 0.7); }  /* Cyan */
        33%  { box-shadow: 0 0 25px 8px rgba(244, 114, 182, 0.7); } /* Pink */
        66%  { box-shadow: 0 0 25px 8px rgba(192, 132, 252, 0.7); } /* Purple */
        100% { box-shadow: 0 0 25px 8px rgba(56, 189, 248, 0.7); }  /* Back to Cyan */
    }
</style>

<div id="csrf-token-container" data-csrf="{{ csrf_token }}" style="display: none;"></div>
<div class="relative min-h-screen w-full bg-black antialiased text-white overflow-hidden">
    
    <!-- =============================================================== -->
    <!-- PAGE BACKGROUND                                                 -->
    <!-- =============================================================== -->
    
    {% include 'app_web/components/background.html' %}

    <!-- Main Content Container (Adds margins) -->
    <div class="w-full max-w-screen mx-auto px-4 lg:px-6 pt-20">
        
        <!-- This is the main grid for the page layout. -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" style="height: calc(100vh - 7rem);">

            <!-- =============================================================== -->
            <!-- LEFT COLUMN: HERO PREVIEW                                       -->
            <!-- =============================================================== -->
            <div id="hero-section" class="relative w-full h-full bg-slate-900 border border-slate-700 rounded-lg shadow-2xl overflow-hidden">
                <!-- NEW: Decorative corner brackets for a high-tech feel -->
                <div class="absolute top-2 left-2 w-8 h-8 border-t-2 border-l-2 border-slate-600/50 rounded-tl-lg"></div>
                <div class="absolute top-2 right-2 w-8 h-8 border-t-2 border-r-2 border-slate-600/50 rounded-tr-lg"></div>
                <div class="absolute bottom-2 left-2 w-8 h-8 border-b-2 border-l-2 border-slate-600/50 rounded-bl-lg"></div>
                <div class="absolute bottom-2 right-2 w-8 h-8 border-b-2 border-r-2 border-slate-600/50 rounded-br-lg"></div>

                <img id="hero-image" src="" alt="Banner Preview" class="absolute inset-0 w-full h-full object-cover z-0 transition-opacity duration-500 opacity-0">
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent z-10"></div>
                <div id="hero-banner-name" class="absolute bottom-0 left-0 p-6 z-20 text-5xl font-black text-white uppercase tracking-widest opacity-0 transition-all duration-500 transform translate-y-4" style="text-shadow: 2px 2px 10px rgba(0,0,0,0.7);"></div>
            </div>

            <!-- =============================================================== -->
            <!-- RIGHT COLUMN: INTERACTION PANEL                                 -->
            <!-- =============================================================== -->
            <div class="w-full h-full grid grid-rows-5 gap-6">
                
                <!-- Upper Row (2/5 height): Banner Carousel -->
                <div id="banner-carousel" class="relative row-span-2 w-full h-full overflow-hidden">
                    {% for banner in banners %}
                    <div class="banner-card absolute top-1/2 left-1/2 h-full w-[100%] transition-all duration-500 ease-in-out rounded-lg overflow-hidden cursor-pointer"
                         data-index="{{ forloop.counter0 }}"
                         data-banner-id="{{ banner.banner_id }}"
                         data-name="{{ banner.banner_name }}"
                         data-hero-image-url=""
                    >
                        <!-- <img src="{% url 'serve_banner_image' banner_id=banner.banner_id %}" class="w-full h-full object-contain"> -->
                        <!-- MODIFIED: Wrapped the image in a div for easier grayscale control -->
                        <div class="card-image-wrapper w-full h-full">
                            <img src="{% url 'serve_banner_image' banner_id=banner.banner_id %}" class="w-full h-full object-contain">
                        </div>
                    </div>
                    {% endfor %}
                    <!-- Navigation Arrows -->
                    <button class="nav-arrow nav-left absolute left-6 bottom-0 bg-black/40 p-3 rounded-full hover:bg-sky-500/50 transition-colors z-40">
                        <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    <button class="nav-arrow nav-right absolute right-6 bottom-0 bg-black/40 p-3 rounded-full hover:bg-sky-500/50 transition-colors z-40">
                        <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </button>

                    <!-- NEW: Index Indicator Dots -->
                    <div id="indicator-dots" class="absolute bottom-0 left-1/2 -translate-x-1/2 flex gap-2 z-20">
                        {% for banner in banners %}
                        <div class="indicator-dot w-2 h-2 bg-white/30 rounded-full transition-all duration-300" data-index="{{ forloop.counter0 }}"></div>
                        {% endfor %}
                    </div>
                
                </div>

                <!-- Lower Row (3/5 height): Action Panel -->
                <div class="row-span-3 w-full h-full bg-black/30 backdrop-blur-sm border border-slate-700 rounded-lg p-6 flex items-center justify-between">
                    <div class="flex flex-col gap-4">
                        <button id="details-button" class="px-6 py-3 text-lg font-semibold border-2 border-slate-500 hover:border-cyan-400 hover:text-cyan-400 rounded-lg transition-colors">Banner Details</button>
                        
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex flex-col items-center gap-1">
                            <button id="one-pull-button" class="w-36 px-4 py-3 flex justify-center bg-slate-600 hover:bg-slate-500 rounded-lg text-xl font-bold transition-colors gap-2">
                                <img src="{% static 'images/web/pull01.png' %}" alt="PULL x1" class="w-10 w-10 object-contain">
                                <span>PULL x1</span>
                            </button>
                            <span class="text-sm text-slate-400">120 Pyroxene</span>
                        </div>
                        <div class="flex flex-col items-center gap-1">
                            <button id="ten-pull-button" class="w-36 px-4 py-3 flex justify-center bg-cyan-600 hover:bg-cyan-500 rounded-lg text-xl font-bold transition-colors gap-2">
                                <img src="{% static 'images/web/pull10.png' %}" alt="PULL x10" class="w-10 w-10 object-contain">
                                <span>PULL x10</span> 
                            </button>
                            <span class="text-sm text-slate-400">1200 Pyroxene</span>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <!-- =============================================================== -->
    <!-- NEW: TOAST NOTIFICATION CONTAINER                               -->
    <!-- =============================================================== -->
    <!-- This container will hold all the achievement popups. -->
    <div id="toast-container" class="fixed top-24 right-4 z-[100] flex flex-col items-end gap-2">
        <!-- Toasts will be injected here by JavaScript -->
    </div>

    <!-- =============================================================== -->
    <!-- GACHA DETAILS MODAL: (Initially hidden)                               -->
    <!-- =============================================================== -->
    <div id="details-modal-wrapper" class="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 hidden">
        <div id="details-modal-panel" class="relative w-full max-w-4xl h-[80vh] bg-slate-800 border border-slate-600 rounded-lg shadow-2xl transform scale-95 opacity-0 transition-all duration-300">
            <button id="details-modal-close" class="absolute top-2 right-2 text-slate-400 hover:text-white z-10 text-4xl leading-none">&times;</button>
            <div id="details-modal-content" class="w-full h-full">
                <!-- Content will be injected here by JavaScript. -->
            </div>
        </div>
    </div>

    <!-- =============================================================== -->
    <!-- GACHA RESULTS MODAL (Initially hidden)                     -->
    <!-- =============================================================== -->
    <div id="results-modal-wrapper" class="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 hidden">
        <div id="results-modal-panel" class="relative w-full max-w-7xl h-[90vh] bg-slate-800 border border-slate-600 rounded-lg shadow-2xl transform scale-95 opacity-0 transition-all duration-300">
            <button id="results-modal-close" class="absolute top-2 right-2 text-slate-400 hover:text-white z-10 text-4xl leading-none">&times;</button>
            <div id="results-modal-content" class="w-full h-full">
                <!-- Content will be injected here by JavaScript. -->
            </div>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- SECURE CSRF TOKEN INITIALIZATION                     ---
    const csrfTokenContainer = document.getElementById('csrf-token-container');
    if (!csrfTokenContainer) {
        console.error('CRITICAL: CSRF Token container not found. POST requests will fail.');
        return; // Stop execution if the token is missing.
    }
    
    // Retrieve the token from the data attribute.
    const csrfToken = csrfTokenContainer.dataset.csrf;
    
    // Immediately remove the temporary div from the DOM.
    csrfTokenContainer.remove();

    const toastContainer = document.getElementById('toast-container');

    function showAchievementToast(achievement) {
        if (!toastContainer) return;

        // 1. Create the toast element
        const toast = document.createElement('div');
        toast.className = 'flex items-center gap-3 p-3 bg-slate-800 border border-slate-600 rounded-lg shadow-2xl w-80 transform translate-x-full opacity-0 transition-all duration-300 ease-in-out';
        
        // 2. Construct the icon URL on the frontend.
        // This line perfectly matches your URL pattern: path('image/achievement/<int:achievement_id>/', ...)
        const iconUrl = `/image/achievement/${achievement.id}/`;

        // 3. Populate the toast's HTML using the constructed URL.
        toast.innerHTML = `
            <div class="flex-shrink-0 w-12 h-12 bg-slate-700 rounded-md">
                <img src="${iconUrl}" class="w-full h-full object-cover rounded-md">
            </div>
            <div class="flex-grow">
                <p class="text-xs text-cyan-400 font-semibold">Achievement Unlocked!</p>
                <h4 class="font-bold text-white">${achievement.name}</h4>
            </div>
            <button class="toast-close-btn flex-shrink-0 text-slate-500 hover:text-white text-2xl leading-none">&times;</button>
        `;

        // 4. Add it to the container and manage its lifecycle (animations, timers).
        toastContainer.appendChild(toast);
        setTimeout(() => toast.classList.remove('translate-x-full', 'opacity-0'), 10);
        const autoCloseTimer = setTimeout(() => {
            toast.classList.add('opacity-0', 'translate-x-4'); // Fade and move out
            setTimeout(() => toast.remove(), 300); // Remove from DOM after animation
        }, 7000); // Stays on screen for 7 seconds
        toast.querySelector('.toast-close-btn').addEventListener('click', () => {
            clearTimeout(autoCloseTimer); // Stop the auto-close timer
            toast.classList.add('opacity-0', 'translate-x-4');
            setTimeout(() => toast.remove(), 300);
        });
    }

    // --- Get references to all key elements ---
    const heroImage = document.getElementById('hero-image');
    const heroBannerName = document.getElementById('hero-banner-name');
    const carousel = document.getElementById('banner-carousel');
    const cards = Array.from(carousel.querySelectorAll('.banner-card'));
    const totalCards = cards.length;
    let currentIndex = 0;

    // Get reference to the indicator dots
    const indicatorDots = Array.from(carousel.querySelectorAll('.indicator-dot'));

    // --- Gacha Details Modal Logic ---
    const detailsButton = document.getElementById('details-button');
    const modalWrapper = document.getElementById('details-modal-wrapper');
    const modalPanel = document.getElementById('details-modal-panel');
    const modalContent = document.getElementById('details-modal-content');
    const modalClose = document.getElementById('details-modal-close');

    // --- Gacha Results Modal Logic
    const pullOneButton = document.getElementById('one-pull-button');
    const pullTenButton = document.getElementById('ten-pull-button');

    const resultsModalWrapper = document.getElementById('results-modal-wrapper');
    const resultsModalPanel = document.getElementById('results-modal-panel');
    const resultsModalContent = document.getElementById('results-modal-content');
    const resultsModalClose = document.getElementById('results-modal-close');

    async function showDetailsModal() {
        const activeCard = carousel.querySelector(`.banner-card[data-index='${currentIndex}']`);
        if (!activeCard) return;

        modalWrapper.classList.remove('hidden');
        setTimeout(() => modalPanel.classList.remove('scale-95', 'opacity-0'), 10);
        modalContent.innerHTML = `<div class="w-full h-full flex items-center justify-center"><svg class="animate-spin h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg></div>`;

        try {
            const bannerId = activeCard.dataset.bannerId;
            const response = await fetch(`/banner-details/${bannerId}/`);
            if (!response.ok) throw new Error('Failed to load details');
            
            const htmlString = await response.text();
            
            // --- THE FIX ---
            // 1. Create a temporary, disconnected DOM element to parse the response.
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlString;

            // 2. Extract the HTML content and the script content using their new IDs.
            const htmlContent = tempDiv.querySelector('#modal-html-content');
            const scriptContent = tempDiv.querySelector('#modal-js-script');

            // 3. Inject the HTML into the modal.
            if (htmlContent) {
                modalContent.innerHTML = htmlContent.innerHTML;
            } else {
                throw new Error('Modal content is missing from the response.');
            }

            // 4. IMPORTANT: Execute the script's content.
            // We use eval() here, which is safe because we trust the source (our own server).
            // This is the standard pattern for this exact problem.
            if (scriptContent) {
                eval(scriptContent.textContent);
            }

        } catch (error) {
            modalContent.innerHTML = `<p class="text-center text-red-400">${error.message}</p>`;
        }
    }

    function hideDetailsModal() {
        modalPanel.classList.add('scale-95', 'opacity-0');
        setTimeout(() => modalWrapper.classList.add('hidden'), 300);
    }
    
    detailsButton.addEventListener('click', showDetailsModal);
    modalClose.addEventListener('click', hideDetailsModal);
    modalWrapper.addEventListener('click', (e) => { if (e.target === modalWrapper) hideDetailsModal(); });

    async function pullGacha(pullAction) {
        const activeCard = carousel.querySelector(`.banner-card[data-index='${currentIndex}']`);
        if (!activeCard) return;

        // Show the modal with a loading state.
        resultsModalContent.innerHTML = `<div class="w-full h-full flex items-center justify-center"><p class="text-2xl text-slate-300">Pulling...</p></div>`;
        resultsModalWrapper.classList.remove('hidden');
        setTimeout(() => resultsModalPanel.classList.remove('scale-95', 'opacity-0'), 10);
        
        try {
            const bannerId = activeCard.dataset.bannerId;
            const pullApiUrl = `/api/gacha/${bannerId}/${pullAction}/`;
            
            // Step 1: Call the API to get student IDs.
            const pullResponse = await fetch(pullApiUrl, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
            });
            if (!pullResponse.ok) throw new Error('Gacha pull failed on server.');
            const pullData = await pullResponse.json();
            if (!pullData.success) throw new Error('Server indicated a pull failure.');

            // --- THE TRIGGER ---
            // After a successful pull, check for new achievements in the response.
            if (pullData.unlocked_achievements && pullData.unlocked_achievements.length > 0) {
                // Loop through the unlocked achievements and show a toast for each one.
                pullData.unlocked_achievements.forEach((ach, index) => {
                    // Stagger the notifications so they appear one after another.
                    setTimeout(() => {
                        showAchievementToast(ach);
                    }, index * 500); // 500ms delay between each toast
                });
            }

            // Step 2: Call the rendering endpoint to get the HTML + Script content.
            const renderResponse = await fetch('/banner-result/', {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/json' },
                body: JSON.stringify({ results: pullData.results })
            });
            if (!renderResponse.ok) throw new Error('Failed to render gacha results.');
            
            const responseText = await renderResponse.text();

            // --- THE FIX ---
            // 3. Create a temporary element to parse the response.
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = responseText;

            // 4. Extract the HTML content and the script content.
            const htmlContent = tempDiv.querySelector('#gacha-results-html-content');
            const scriptContent = tempDiv.querySelector('#gacha-results-js-script');

            // 5. Inject the HTML into the modal.
            if (htmlContent) {
                resultsModalContent.innerHTML = htmlContent.innerHTML;
            } else {
                throw new Error('Modal content is missing from the response.');
            }

            // 6. Execute the script's content.
            if (scriptContent) {
                eval(scriptContent.textContent);
            }

        } catch (error) {
            resultsModalContent.innerHTML = `<p class="text-center text-red-400 p-4">${error.message}</p>`;
        }
    }
    
    function hideResultsModal() {
        resultsModalPanel.classList.add('scale-95', 'opacity-0');
        setTimeout(() => resultsModalWrapper.classList.add('hidden'), 300);
    }

    // --- Attach event listeners ---
    pullOneButton.addEventListener('click', () => pullGacha('draw_one'));
    pullTenButton.addEventListener('click', () => pullGacha('draw_ten'));
    resultsModalClose.addEventListener('click', hideResultsModal);

    // --- Main Carousel & Hero View Logic ---
    function updateHeroView() {
        const activeCard = carousel.querySelector(`.banner-card[data-index='${currentIndex}']`);
        if (!activeCard) return;

        heroBannerName.classList.add('opacity-0', 'translate-y-4');
        heroImage.classList.add('opacity-0');

        setTimeout(() => {
            heroBannerName.textContent = activeCard.dataset.name;
            heroImage.src = activeCard.dataset.heroImageUrl || '';
            heroBannerName.classList.remove('opacity-0', 'translate-y-4');
            heroImage.classList.remove('opacity-0');
        }, 300);
    }

    function updateCarousel() {
        // --- THE RESPONSIVE FIX ---
        // 1. Define the breakpoint. 1024px is the default for Tailwind's 'lg'.
        const DESKTOP_BREAKPOINT = 1024;
        const isDesktop = window.innerWidth >= DESKTOP_BREAKPOINT;

        // 2. Choose different layout values based on the screen size.
        // On desktop, we want a wider gap. On mobile, a much smaller gap.
        const gapMultiplier = isDesktop ? 65 : 30;
        // On mobile, the inactive cards should be smaller to look less crowded.
        const inactiveScale = isDesktop ? 0.7 : 0.6;

        cards.forEach((card, i) => {
            const offset = i - currentIndex;
            const loopedOffset = (offset + totalCards + Math.floor(totalCards / 2)) % totalCards - Math.floor(totalCards / 2);

            const scale = loopedOffset === 0 ? 1.0 : inactiveScale;
            // 3. Use the new adaptive gapMultiplier.
            const translateX = loopedOffset * gapMultiplier;
            const opacity = Math.abs(loopedOffset) > 1 ? 0 : 1;
            const zIndex = totalCards - Math.abs(loopedOffset);

            card.style.transform = `translateY(-50%) translateX(calc(-50% + ${translateX}%)) scale(${scale})`;
            card.style.opacity = opacity;
            card.style.zIndex = zIndex;

            // Grayscale Logic (unchanged)
            const imageWrapper = card.querySelector('.card-image-wrapper');
            if (loopedOffset === 0) {
                imageWrapper.classList.remove('grayscale');
            } else {
                imageWrapper.classList.add('grayscale');
            }
        });

        // Indicator Dots Logic (unchanged)
        indicatorDots.forEach((dot, i) => {
            if (i === currentIndex) {
                dot.classList.add('bg-white');
                dot.classList.remove('bg-white/30');
            } else {
                dot.classList.remove('bg-white');
                dot.classList.add('bg-white/30');
            }
        });

        updateHeroView();
    }

    // --- Event Listeners ---
    carousel.querySelector('.nav-left')?.addEventListener('click', () => {
        currentIndex = (currentIndex - 1 + totalCards) % totalCards;
        updateCarousel();
    });
    carousel.querySelector('.nav-right')?.addEventListener('click', () => {
        currentIndex = (currentIndex + 1) % totalCards;
        updateCarousel();
    });
    cards.forEach(card => {
        card.addEventListener('click', () => {
            currentIndex = parseInt(card.dataset.index);
            updateCarousel();
        });
    });
    window.addEventListener('resize', updateCarousel); // Re-center on resize

    // --- Initial Load ---
    updateCarousel();

});
</script>
{% endblock %}
