<!-- This template now contains the table, pagination controls, and its own script. -->

<!-- This div wraps all the visible HTML for parsing by eval(). -->
<div id="history-html-content">
    
    <!-- This inner wrapper is the target for our AJAX content replacement. -->
    <div id="history-table-wrapper">
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <!-- MODIFIED: The table header now has 4 columns -->
                <thead class="border-b border-slate-600 text-sm text-slate-400">
                    <tr>
                        <th class="p-2 w-[20%]">Date</th>
                        <th class="p-2 w-[25%]">Banner</th>
                        <th class="p-2 w-[45%]">Student</th>
                        <th class="p-2 w-[10%]">Rarity</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tx in transactions_page %}
                    <tr class="border-b border-slate-700/50 
                        {% if tx.student_id.student_rarity == 3 %}bg-yellow-500/10 text-yellow-300 font-semibold{% endif %}
                    ">
                        <!-- Datetime Column (Unchanged) -->
                        <td class="p-2 text-slate-400 font-mono">{{ tx.transaction_create_on|date:"Y-m-d H:i" }}</td>
                        
                        <!-- Banner Image Column (Unchanged) -->
                        <td class="p-2">
                            <img src="{% url 'serve_banner_image' banner_id=tx.banner_id.banner_id %}" class="w-32 h-auto rounded-md object-cover">
                        </td>
                        
                        <!-- Student Info Column (Now simpler) -->
                        <td class="p-2">
                            <div class="flex flex-col">
                                <span class="text-lg">{{ tx.student_id.name }}</span>
                                {% if tx.student_id.version != 'Original' %}
                                    <span class="text-sm text-slate-400">({{ tx.student_id.version }})</span>
                                {% endif %}
                            </div>
                        </td>

                        <!-- NEW: Rarity Column -->
                        <td class="p-2">
                            <div class="flex">
                                {% for i in "x"|rjust:tx.student_id.student_rarity %}<span>â˜…</span>{% endfor %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- =============================================================== -->
        <!-- PAGINATION CONTROLS                                             -->
        <!-- =============================================================== -->
        <div class="flex items-center justify-between mt-4 text-sm">
            <!-- Page Number Info -->
            <span class="text-slate-400">
                Page {{ transactions_page.number }} of {{ transactions_page.paginator.num_pages }}.
            </span>
            
            <!-- Navigation Buttons -->
            <div class="flex gap-2">
                {% if transactions_page.has_previous %}
                    <a href="?page=1" class="page-link px-3 py-1 bg-slate-700 rounded-md hover:bg-slate-600">&laquo; First</a>
                    <a href="?page={{ transactions_page.previous_page_number }}" class="page-link px-3 py-1 bg-slate-700 rounded-md hover:bg-slate-600">Previous</a>
                {% endif %}
                {% if transactions_page.has_next %}
                    <a href="?page={{ transactions_page.next_page_number }}" class="page-link px-3 py-1 bg-slate-700 rounded-md hover:bg-slate-600">Next</a>
                    <a href="?page={{ transactions_page.paginator.num_pages }}" class="page-link px-3 py-1 bg-slate-700 rounded-md hover:bg-slate-600">Last &raquo;</a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- This script is separated and will be executed by eval() in the main dashboard page. -->
<script id="history-js-script">
    (function() {
        const contentWrapper = document.getElementById('history-html-content');
        if (!contentWrapper) return;
        
        const pageLinks = contentWrapper.querySelectorAll('.page-link');

        async function loadPage(url) {
            // Find the wrapper by its ID each time to ensure we're targeting the current one.
            const tableWrapper = document.getElementById('history-table-wrapper');
            if (!tableWrapper) return;

            tableWrapper.style.opacity = 0.5;
            try {
                // THE FIX: The full, correct URL is now passed directly to fetch.
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to load page.');
                
                const responseText = await response.text();
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = responseText;
                const newTableWrapper = tempDiv.querySelector('#history-table-wrapper');

                if (newTableWrapper) {
                    tableWrapper.innerHTML = newTableWrapper.innerHTML;
                    // IMPORTANT: We must re-attach the event listeners to the new links.
                    reAttachListeners();
                }

            } catch (error) {
                tableWrapper.innerHTML = `<p class="text-red-400">${error.message}</p>`;
            } finally {
                tableWrapper.style.opacity = 1;
            }
        }
        
        // This function re-runs the logic to find and attach click handlers.
        function reAttachListeners() {
            const newPageLinks = document.querySelectorAll('#history-table-wrapper .page-link');
            newPageLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    // Construct the full, correct API URL.
                    const url = `/dashboard/content/history/${link.getAttribute('href')}`;
                    loadPage(url);
                });
            });
        }

        // Run this once for the initial set of links.
        reAttachListeners();

    })();
</script>