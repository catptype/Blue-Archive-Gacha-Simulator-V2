<!-- This template is now a self-contained component with its own script for the chart. -->
{% load static %}
<!-- This div wraps all the visible HTML for parsing by eval(). -->
<div class="tab-html-content">
    
    <!-- =============================================================== -->
    <!-- 1. KPI WIDGETS (Key Performance Indicators)                       -->
    <!-- =============================================================== -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="p-4 bg-slate-700/50 rounded-lg text-center"><div class="text-4xl font-bold">{{ total_pulls|default:0 }}</div><div class="text-sm text-slate-400">Total Pulls</div></div>
        <div class="p-4 bg-yellow-500/20 rounded-lg text-center"><div class="text-4xl font-bold">{{ r3_count|default:0 }}</div><div class="text-sm text-yellow-300">★★★ Students</div></div>
        <div class="p-4 bg-purple-500/20 rounded-lg text-center"><div class="text-4xl font-bold">{{ r2_count|default:0 }}</div><div class="text-sm text-purple-300">★★ Students</div></div>
        <div class="p-4 bg-blue-500/20 rounded-lg text-center"><div class="text-4xl font-bold">{{ r1_count|default:0 }}</div><div class="text-sm text-blue-300">★ Students</div></div>
    </div>

    <!-- =============================================================== -->
    <!-- TOP STUDENTS WIDGET (REVISED)                                   -->
    <!-- =============================================================== -->
    <!-- THE FIX: The widget now has the same styling as all other dashboard components. -->
    <div class="mb-6 p-4 bg-slate-700/50 rounded-lg">
        <h3 class="text-xl font-semibold mb-4">Most Pulled Students by Rarity</h3>
        <div class="flex gap-6">
            <!-- Left Side: Rarity Tabs -->
            <nav class="flex flex-col gap-2">
                <button class="rarity-tab p-3 rounded-lg font-semibold" data-rarity="3">★★★</button>
                <button class="rarity-tab p-3 rounded-lg font-semibold" data-rarity="2">★★</button>
                <button class="rarity-tab p-3 rounded-lg font-semibold" data-rarity="1">★</button>
            </nav>
            <!-- Right Side: Podium Content Area -->
            <div id="podium-content" class="flex-grow h-full">
                <!-- Initial podium is rendered here -->
                {% include 'app_web/components/dashboard-podium.html' with top_students=top_r3_students %}
            </div>
        </div>
    </div>

    <!-- Main Dashboard Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- =============================================================== -->
        <!-- Rarity Distribution Chart (Unchanged)                           -->
        <!-- =============================================================== -->
        <div class="lg:col-span-2 p-4 bg-slate-700/50 rounded-lg">
            <h3 class="text-xl font-semibold mb-4">Rarity Distribution</h3>
            <canvas id="rarityPieChart"></canvas>
        </div>

        <!-- =============================================================== -->
        <!-- NEW: Banner Distribution Chart                                  -->
        <!-- =============================================================== -->
        <div class="lg:col-span-1 p-4 bg-slate-700/50 rounded-lg">
            <h3 class="text-xl font-semibold mb-4">Banner Distribution</h3>
            <!-- A horizontal bar chart is perfect for a potentially long list of banners. -->
            <canvas id="bannerBarChart"></canvas>
        </div>

        <!-- =============================================================== -->
        <!-- NEW: PER-BANNER PULL ANALYSIS                                   -->
        <!-- =============================================================== -->
        <div class="lg:col-span-3 p-4 bg-slate-700/50 rounded-lg">
            <h3 class="text-xl font-semibold mb-4">3-Star Pull Analysis by Banner</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="border-b border-slate-600">
                        <tr>
                            <th class="p-2">Banner</th>
                            <th class="p-2 text-center">Total Pulls</th>
                            <th class="p-2 text-center">3-Star Count</th>
                            <th class="p-2 text-center">Shortest Gap</th>
                            <th class="p-2 text-center">Longest Gap</th>
                            <th class="p-2 text-center">Average Gap</th>
                            <th class="p-2 text-center">Stdev Gap</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for analysis in banner_analysis %}
                        <tr class="border-b border-slate-700/50">
                            <td class="p-2 font-semibold">{{ analysis.banner_name }}</td>
                            <td class="p-2 text-center">{{ analysis.total_pulls }}</td>
                            <td class="p-2 text-center text-yellow-300 font-bold">{{ analysis.r3_count }}</td>
                            <td class="p-2 text-center">{{ analysis.gaps.min|default:"N/A" }}</td>
                            <td class="p-2 text-center">{{ analysis.gaps.max|default:"N/A" }}</td>
                            <td class="p-2 text-center">{{ analysis.gaps.avg|default:"N/A" }}</td>
                            <td class="p-2 text-center">{{ analysis.gaps.stdev|default:"N/A" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>



</div>

<!-- The script to initialize the chart -->
<script class="tab-js-script">
    (function() {

        // --- NEW: PODIUM TAB LOGIC ---
        const contentWrapper = document.querySelector('.tab-html-content');
        if (!contentWrapper) return;

        const rarityTabs = contentWrapper.querySelectorAll('.rarity-tab');
        const podiumContainer = contentWrapper.querySelector('#podium-content');
        let isLoadingPodium = false;

        async function loadPodiumContent(rarity) {
            if (isLoadingPodium) return;
            isLoadingPodium = true;

            // Update tab styles
            rarityTabs.forEach(tab => {
                if (tab.dataset.rarity == rarity) {
                    tab.classList.add('bg-cyan-600', 'text-white');
                    tab.classList.remove('bg-slate-700/50', 'text-slate-400');
                } else {
                    tab.classList.remove('bg-cyan-600', 'text-white');
                    tab.classList.add('bg-slate-700/50', 'text-slate-400');
                }
            });

            // Show loading state
            podiumContainer.style.opacity = 0.5;

            try {
                const response = await fetch(`/dashboard/top-students/${rarity}/`);
                if (!response.ok) throw new Error('Failed to load podium data.');
                podiumContainer.innerHTML = await response.text();
            } catch (error) {
                podiumContainer.innerHTML = `<p class="text-red-400">${error.message}</p>`;
            } finally {
                isLoadingPodium = false;
                podiumContainer.style.opacity = 1;
            }
        }

        // Attach listeners
        rarityTabs.forEach(tab => {
            tab.addEventListener('click', () => loadPodiumContent(tab.dataset.rarity));
        });

        // Set initial active state for the default (3-star) tab
        rarityTabs[0].click();






        // --- Include Chart.js library ---
        // We dynamically add the script to the page to ensure it's available.
        if (!document.getElementById('chartjs-script')) {
            const script = document.createElement('script');
            script.id = 'chartjs-script';
            script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
            document.head.appendChild(script);
        }

        const createChart = () => {
            const pieCtx = document.getElementById('rarityPieChart');
            if (pieCtx) {
                new Chart(pieCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['★★★', '★★', '★'],
                        datasets: [{
                            label: 'Pulls',
                            // These values are passed directly from the Django view.
                            data: [{{ r3_count|default:0 }}, {{ r2_count|default:0 }}, {{ r1_count|default:0 }}],
                            backgroundColor: [
                                'rgba(250, 204, 21, 0.7)',  // Yellow
                                'rgba(192, 132, 252, 0.7)', // Purple
                                'rgba(96, 165, 250, 0.7)'   // Blue
                            ],
                            borderColor: [
                                '#FBBF24',
                                '#C084FC',
                                '#60A5FA'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: '#cbd5e1' // slate-300
                                }
                            }
                        }
                    }
                });
            }

            // --- NEW: Banner Bar Chart ---
            const barCtx = document.getElementById('bannerBarChart');
            if (barCtx) {
                // Get the data passed from the Django view.
                const bannerData = {{ banner_distribution|safe }};
                
                new Chart(barCtx, {
                    type: 'bar', // A bar chart is better for many items.
                    data: {
                        labels: bannerData.map(item => item.banner_id__banner_name),
                        datasets: [{
                            label: 'Pulls',
                            data: bannerData.map(item => item.count),
                            backgroundColor: 'rgba(56, 189, 248, 0.7)', // Cyan
                            borderColor: '#38BDF8',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y', // Makes the bar chart horizontal - crucial for long labels.
                        responsive: true,
                        plugins: {
                            legend: { display: false }, // Hide the legend for a cleaner look.
                        },
                        scales: {
                            y: { ticks: { color: '#cbd5e1' } },
                            x: { ticks: { color: '#cbd5e1' } }
                        }
                    }
                });
            }
        };
        
        // Wait for the Chart.js library to load before creating the chart.
        if (typeof Chart !== 'undefined') {
            createChart();
        } else {
            document.getElementById('chartjs-script').addEventListener('load', createChart);
        }
    })();
</script>