<!-- This template is now a self-contained component with its own script for the chart. -->
{% load static %}
<!-- This div wraps all the visible HTML for parsing by eval(). -->
<div class="tab-html-content">
    
    <!-- =============================================================== -->
    <!-- 1. KPI WIDGETS (Key Performance Indicators)                       -->
    <!-- =============================================================== -->
    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
        <div class="p-4 bg-slate-700/50 rounded-lg text-center"><div class="text-3xl font-bold">{{ total_pulls|default:0 }}</div><div class="text-sm text-slate-400">Total Pulls</div></div>
        
        <!-- NEW: Pyroxene Usage Widget -->
        <div class="md:col-span-2 lg:col-span-1 p-4 bg-slate-700/50 rounded-lg text-center">
            <div class="flex items-center justify-center gap-2 text-3xl font-bold">
                <img src="{% static 'images/web/pyroxene.png' %}" class="h-8 w-8"> <!-- Assuming you have a pyroxene icon -->
                <span>{{ total_pyroxene_spent|default:0 }}</span>
            </div>
            <div class="text-sm text-slate-400">Pyroxene Spent</div>
        </div>
        
        <div class="p-4 bg-yellow-500/20 rounded-lg text-center"><div class="text-3xl font-bold">{{ r3_count|default:0 }}</div><div class="text-sm text-yellow-300">★★★ Students</div></div>
        <div class="p-4 bg-purple-500/20 rounded-lg text-center"><div class="text-3xl font-bold">{{ r2_count|default:0 }}</div><div class="text-sm text-purple-300">★★ Students</div></div>
        <div class="p-4 bg-blue-500/20 rounded-lg text-center"><div class="text-3xl font-bold">{{ r1_count|default:0 }}</div><div class="text-sm text-blue-300">★ Students</div></div>
    </div>

    <!-- =============================================================== -->
    <!-- NEW: COMBINED "HALL OF FAME" ROW                                -->
    <!-- =============================================================== -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        
        <!-- =============================================================== -->
        <!-- LEFT (2/3 width): TOP STUDENTS WIDGET (with Folder Tabs)      -->
        <!-- =============================================================== -->
        <div class="relative lg:col-span-2">
            <!-- Rarity Folder Tabs -->
            <div class="absolute -top-px z-20 flex gap-1">
                <button class="rarity-tab px-6 py-2 rounded-t-lg transition-colors duration-200 border-x border-t" data-rarity="3">★★★</button>
                <button class="rarity-tab px-6 py-2 rounded-t-lg transition-colors duration-200 border-x border-t" data-rarity="2">★★</button>
                <button class="rarity-tab px-6 py-2 rounded-t-lg transition-colors duration-200 border-x border-t" data-rarity="1">★</button>
            </div>

            <!-- Podium Content Panel -->
            <div id="podium-content-wrapper" class="relative z-10 w-full min-h-[480px] pt-12 p-4 bg-slate-700/50 backdrop-blur-sm border border-slate-600 rounded-lg">
                <!-- The podium content will be injected here -->
                <div id="podium-content" class="h-full">
                    {% include 'app_web/components/dashboard-podium.html' with top_students=top_r3_students %}
                </div>
            </div>
        </div>

        <!-- =============================================================== -->
        <!-- RIGHT (1/3 width): "FIRST ★★★ PULL" WIDGET                      -->
        <!-- =============================================================== -->
        <div class="lg:col-span-1 p-4 bg-slate-700/50 rounded-lg flex flex-col items-center justify-center min-h-[480px]">
            <h3 class="text-xl font-semibold mb-4">Your First ★★★ Pull</h3>
            {% if first_r3_pull %}
                <!-- Use a transform to scale the card down slightly to fit better -->
                <div class="transform scale-90">
                    {% include 'app_web/components/student-card-static.html' with student=first_r3_pull.student_id %}
                </div>
                <p class="text-sm text-slate-400 mt-2">Pulled on {{ first_r3_pull.transaction_create_on|date:"Y-m-d" }}</p>
            {% else %}
                <p class="text-slate-400">Keep pulling to find your first 3-star!</p>
            {% endif %}
        </div>
    </div>

    <!-- Main Dashboard Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- =============================================================== -->
        <!-- Rarity Distribution Chart (Unchanged)                           -->
        <!-- =============================================================== -->
        <div class="lg:col-span-2 p-4 bg-slate-700/50 rounded-lg">
            <h3 class="text-xl font-semibold mb-4">Rarity Distribution</h3>
            <canvas id="rarityPieChart"></canvas>
        </div>

        <!-- =============================================================== -->
        <!-- NEW: Banner Distribution Chart                                  -->
        <!-- =============================================================== -->
        <div class="lg:col-span-1 p-4 bg-slate-700/50 rounded-lg">
            <h3 class="text-xl font-semibold mb-4">Banner Distribution</h3>
            <!-- A horizontal bar chart is perfect for a potentially long list of banners. -->
            <canvas id="bannerBarChart"></canvas>
        </div>

        <!-- =============================================================== -->
        <!-- MODIFIED: PER-BANNER ANALYSIS TABLE WITH LUCK METRICS           -->
        <!-- =============================================================== -->
        <div class="lg:col-span-3 p-4 bg-slate-700/50 rounded-lg">
            <h3 class="text-xl font-semibold mb-4">Analysis by Banner</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="border-b border-slate-600">
                        <tr>
                            <th class="p-2">Banner</th>
                            <th class="p-2 text-center">Total Pulls</th>
                            <th class="p-2 text-center">3-Star Count</th>
                            <th class="p-2 text-center">Shortest Gap</th>
                            <th class="p-2 text-center">Longest Gap</th>
                            <th class="p-2 text-center">Average Gap</th>
                            <th class="p-2 text-center">Stdev Gap</th>
                            <th class="p-2 text-center">Your Rate</th>
                            <th class="p-2 text-center">Banner Rate</th>
                            <th class="p-2 text-center">Luck Variance</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for analysis in banner_analysis %}
                        <tr class="border-b border-slate-700/50">
                            <td class="p-2 font-semibold">{{ analysis.banner_name }}</td>
                            <td class="p-2 text-center">{{ analysis.total_pulls }}</td>
                            <td class="p-2 text-center text-yellow-300 font-bold">{{ analysis.r3_count }}</td>
                            <td class="p-2 text-center">{{ analysis.gaps.min|default:"N/A" }}</td>
                            <td class="p-2 text-center">{{ analysis.gaps.max|default:"N/A" }}</td>
                            <td class="p-2 text-center">{{ analysis.gaps.avg|default:"N/A" }}</td>
                            <td class="p-2 text-center">{{ analysis.gaps.stdev|default:"N/A" }}</td>
                            <td class="p-2 text-center">{{ analysis.user_rate }}</td>
                            <td class="p-2 text-center">{{ analysis.banner_rate }}</td>
                            <!-- Conditionally color the luck variance for at-a-glance readability -->
                            <td class="p-2 text-center font-bold 
                                {% if analysis.luck_variance|slice:':1' == '+' %}text-green-400
                                {% elif analysis.luck_variance|slice:':1' == '-' %}text-red-400
                                {% else %}text-slate-400{% endif %}">
                                {{ analysis.luck_variance }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>

</div>

<!-- The script to initialize the chart -->
<script class="tab-js-script">
    (function() {

        // --- NEW: PODIUM TAB LOGIC ---
        const contentWrapper = document.querySelector('.tab-html-content');
        if (!contentWrapper) return;

        const rarityTabs = contentWrapper.querySelectorAll('.rarity-tab');
        const podiumContainer = contentWrapper.querySelector('#podium-content');
        let isLoadingPodium = false;

        async function loadPodiumContent(rarity) {
            if (isLoadingPodium) return;
            isLoadingPodium = true;

            // Update tab styles
            rarityTabs.forEach(tab => {
                if (tab.dataset.rarity == rarity) {
                    tab.classList.add('bg-cyan-600', 'text-white');
                    tab.classList.remove('bg-slate-700/50', 'text-slate-400');
                } else {
                    tab.classList.remove('bg-cyan-600', 'text-white');
                    tab.classList.add('bg-slate-700/50', 'text-slate-400');
                }
            });

            // Show loading state
            podiumContainer.style.opacity = 0.5;

            try {
                const response = await fetch(`/dashboard/top-students/${rarity}/`);
                if (!response.ok) throw new Error('Failed to load podium data.');
                podiumContainer.innerHTML = await response.text();
            } catch (error) {
                podiumContainer.innerHTML = `<p class="text-red-400">${error.message}</p>`;
            } finally {
                isLoadingPodium = false;
                podiumContainer.style.opacity = 1;
            }
        }

        // Attach listeners
        rarityTabs.forEach(tab => {
            tab.addEventListener('click', () => loadPodiumContent(tab.dataset.rarity));
        });

        // Set initial active state for the default (3-star) tab
        rarityTabs[0].click();

        // --- Include Chart.js library ---
        // We dynamically add the script to the page to ensure it's available.
        if (!document.getElementById('chartjs-script')) {
            const script = document.createElement('script');
            script.id = 'chartjs-script';
            script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
            document.head.appendChild(script);
        }

        const createChart = () => {
            const pieCtx = document.getElementById('rarityPieChart');
            if (pieCtx) {
                new Chart(pieCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['★★★', '★★', '★'],
                        datasets: [{
                            label: 'Pulls',
                            // These values are passed directly from the Django view.
                            data: [{{ r3_count|default:0 }}, {{ r2_count|default:0 }}, {{ r1_count|default:0 }}],
                            backgroundColor: [
                                'rgba(250, 204, 21, 0.7)',  // Yellow
                                'rgba(192, 132, 252, 0.7)', // Purple
                                'rgba(96, 165, 250, 0.7)'   // Blue
                            ],
                            borderColor: [
                                '#FBBF24',
                                '#C084FC',
                                '#60A5FA'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: '#cbd5e1' // slate-300
                                }
                            }
                        }
                    }
                });
            }

            // --- NEW: Banner Bar Chart ---
            const barCtx = document.getElementById('bannerBarChart');
            if (barCtx) {
                // Get the data passed from the Django view.
                const bannerData = {{ banner_distribution|safe }};
                
                new Chart(barCtx, {
                    type: 'bar', // A bar chart is better for many items.
                    data: {
                        labels: bannerData.map(item => item.banner_id__banner_name),
                        datasets: [{
                            label: 'Pulls',
                            data: bannerData.map(item => item.count),
                            backgroundColor: 'rgba(56, 189, 248, 0.7)', // Cyan
                            borderColor: '#38BDF8',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y', // Makes the bar chart horizontal - crucial for long labels.
                        responsive: true,
                        plugins: {
                            legend: { display: false }, // Hide the legend for a cleaner look.
                        },
                        scales: {
                            y: { ticks: { color: '#cbd5e1' } },
                            x: { ticks: { color: '#cbd5e1' } }
                        }
                    }
                });
            }
        };
        
        // Wait for the Chart.js library to load before creating the chart.
        if (typeof Chart !== 'undefined') {
            createChart();
        } else {
            document.getElementById('chartjs-script').addEventListener('load', createChart);
        }
    })();
</script>