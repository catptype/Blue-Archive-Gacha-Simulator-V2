<!-- This template is now a self-contained component with its own script for the chart. -->
{% load static %}
{% load humanize %}
<!-- This div wraps all the visible HTML for parsing by eval(). -->



<div class="tab-html-content">
    
    <!-- =============================================================== -->
    <!-- NEW, RE-DESIGNED KPI SECTION (Two-Row Layout)                   -->
    <!-- =============================================================== -->
    <!-- The outer container is now a flexbox that will stack on small screens -->
    <div class="flex flex-col gap-4 mb-6">
        
        <!-- =============================================================== -->
        <!-- Row 1: Primary Metrics (Total Pulls & Pyroxene)               -->
        <!-- =============================================================== -->
        <!-- This grid has 3 columns. Pyroxene will span 2 of them. -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            
            <!-- Total Pulls (1/3 width on desktop) -->
            <div class="p-4 bg-slate-700/50 rounded-lg text-center flex flex-col justify-center">
                <div class="text-3xl font-bold">{{ total_pulls|intcomma }}</div>
                <div class="text-sm text-slate-400">Total Pulls</div>
            </div>
            
            <!-- Pyroxene Spent (2/3 width on desktop) -->
            <!-- 'md:col-span-2' is the key: it makes this widget twice as wide on medium screens and up. -->
            <div class="sm:col-span-2 p-4 bg-slate-700/50 rounded-lg text-center flex flex-col justify-center">
                <div class="flex items-center justify-center gap-2 text-3xl font-bold">
                    <img src="{% static 'images/web/pyroxene.png' %}" class="h-8 w-8">
                    <span>{{ total_pyroxene_spent|intcomma }}</span>
                </div>
                <div class="text-sm text-sky-300">Pyroxene Spent</div>
            </div>
        </div>

        <!-- =============================================================== -->
        <!-- Row 2: Rarity Breakdown                                         -->
        <!-- =============================================================== -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            
            <!-- Rarity 3 (★★★) Widget -->
            <!-- MODIFIED: Background is now the prismatic gradient, text is a generic bright color -->
            <div class="p-4 bg-gradient-to-br from-pink-400/50 via-purple-400/50 to-cyan-400/50 rounded-lg text-center">
                <div class="text-3xl font-bold text-white">{{ r3_count|intcomma }}</div>
                <div class="text-sm font-semibold text-pink-300">★★★ Students</div>
            </div>
            
            <!-- Rarity 2 (★★) Widget -->
            <!-- MODIFIED: Background and text are now yellow -->
            <div class="p-4 bg-yellow-500/50 rounded-lg text-center">
                <div class="text-3xl font-bold text-white">{{ r2_count|intcomma }}</div>
                <div class="text-sm font-semibold text-yellow-300">★★ Students</div>
            </div>
            
            <!-- Rarity 1 (★) Widget -->
            <!-- MODIFIED: Background and text are now blue -->
            <div class="p-4 bg-blue-500/50 rounded-lg text-center">
                <div class="text-3xl font-bold text-white">{{ r1_count|intcomma }}</div>
                <div class="text-sm font-semibold text-blue-300">★ Students</div>
            </div>
        </div>

    </div>

    <!-- =============================================================== -->
    <!-- NEW: COMBINED "HALL OF FAME" ROW                                -->
    <!-- =============================================================== -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
        
        <!-- =============================================================== -->
        <!-- (3/4) TOP STUDENTS WIDGET (RE-ENGINEERED with Flexbox)                -->
        <!-- =============================================================== -->
        <div class="lg:col-span-3">
            <!-- This is the main flex container for the widget. 'relative' is for the title. -->
            <div class="relative flex">

                <!-- Column 1: Vertical Rarity Tabs -->
                <!-- 'flex-shrink-0' is crucial to give the tabs a fixed width. -->
                <!-- 'z-20' ensures they render on top of the content panel's corner. -->
                <div class="flex flex-col gap-1 z-20 pt-2">
                    <button class="rarity-tab w-10 h-24 flex items-center justify-center rounded-l-lg transition-colors duration-200 border-l border-t border-b" data-rarity="3">
                        <span class="transform -rotate-90 whitespace-nowrap font-semibold">★★★</span>
                    </button>
                    <button class="rarity-tab w-10 h-24 flex items-center justify-center rounded-l-lg transition-colors duration-200 border-l border-t border-b" data-rarity="2">
                        <span class="transform -rotate-90 whitespace-nowrap font-semibold">★★</span>
                    </button>
                    <button class="rarity-tab w-10 h-24 flex items-center justify-center rounded-l-lg transition-colors duration-200 border-l border-t border-b" data-rarity="1">
                        <span class="transform -rotate-90 whitespace-nowrap font-semibold">★</span>
                    </button>
                </div>

                <!-- Column 2: Podium Content Panel -->
                <!-- MODIFIED: Reduced min-height and padding to perfectly fit the scaled content -->
                <div id="podium-content-wrapper" class="relative w-[90%] h-full z-10 flex-grow p-4 bg-slate-700/50 rounded-lg">
                    <h3 class="text-xl font-semibold mb-2">Most Pulled Students</h3>
                    
                    <!-- MODIFIED: The podium content is now permanently scaled to 90% -->
                    <div id="podium-content" class="transform scale-90 origin-center">
                        <!-- Initial podium is rendered here -->
                        {% include 'app_web/components/dashboard-podium.html' with top_students=top_r3_students rarity=3 %}
                    </div>
                </div>
            </div>
        </div>

        <!-- =============================================================== -->
        <!-- RIGHT (1/4 width): "FIRST ★★★ PULL" WIDGET                      -->
        <!-- =============================================================== -->
        <div class="lg:col-span-1 p-4 bg-slate-700/50 rounded-lg flex flex-col items-center justify-between">
            <h3 class="text-xl font-semibold mb-2">Your First ★★★ Pull</h3>
            {% if first_r3_pull %}
                <!-- Use a transform to scale the card down slightly to fit better -->
                <div class="transform scale-90">
                    {% include 'app_web/components/student-card-static.html' with student=first_r3_pull.student_id %}
                </div>
                <p class="text-sm text-slate-400 mt-2">{{ first_r3_pull.transaction_create_on|date:"Y-m-d" }}</p>
            {% else %}
                <p class="text-slate-400">Keep pulling to find your first 3-star!</p>
            {% endif %}
        </div>
    </div>

    <!-- Main Dashboard Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

        <!-- =============================================================== -->
        <!-- Rarity Distribution Chart (Unchanged)                           -->
        <!-- =============================================================== -->
        <div class="p-4 bg-slate-700/50 rounded-lg">
            <h3 class="text-xl font-semibold mb-4">Overall Rarity</h3>
            <canvas id="rarityPieChart"></canvas>
        </div>

        <!-- =============================================================== -->
        <!-- NEW: WIDGET 2: PER-BANNER RARITY DISTRIBUTION                   -->
        <!-- =============================================================== -->
        <!-- 2. NEW: Per-Banner Rarity Distribution Chart (Top-Right) -->
        <div class="relative p-4 bg-slate-700/50 rounded-lg">
            <h3 class="text-xl font-semibold mb-4">Banner Breakdown</h3>
            <!-- The canvas for the new chart -->
            <canvas id="perBannerPieChart"></canvas>
            
            <!-- The banner selector, positioned in the center of the chart -->
            <div class="absolute top-3/5 left-1/2 -translate-x-1/2 -translate-y-1/2 flex flex-col items-center">
                <label for="banner-select" class="text-xs text-slate-400"></label>
                <select id="banner-select" class="bg-slate-800 border border-slate-600 rounded-md text-white p-1 text-sm">
                    {% for banner_item in banner_distribution %}
                        <option value="{{ banner_item.banner_id__banner_name }}">{{ banner_item.banner_id__banner_name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- =============================================================== -->
        <!-- NEW: Banner Distribution Chart                                  -->
        <!-- =============================================================== -->
        <div class="p-4 bg-slate-700/50 rounded-lg">
            <h3 class="text-xl font-semibold mb-4">Banner Activity</h3>
            <!-- A horizontal bar chart is perfect for a potentially long list of banners. -->
            <canvas id="bannerBarChart"></canvas>
        </div>

        <!-- =============================================================== -->
        <!-- MODIFIED: PER-BANNER ANALYSIS TABLE WITH LUCK METRICS           -->
        <!-- =============================================================== -->
        <div class="md:col-span-3 p-4 bg-slate-700/50 rounded-lg">
            <h3 class="text-xl font-semibold mb-4">Luck Performance</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="border-b border-slate-600">
                        <tr>
                            <th class="p-2">Banner</th>
                            <th class="p-2 text-center">Total Pulls</th>
                            <th class="p-2 text-center">3-Star Count</th>
                            <th class="p-2 text-center">Shortest Gap</th>
                            <th class="p-2 text-center">Longest Gap</th>
                            <th class="p-2 text-center">Average Gap</th>
                            <th class="p-2 text-center">Stdev Gap</th>
                            <th class="p-2 text-center">Your Rate</th>
                            <th class="p-2 text-center">Banner Rate</th>
                            <th class="p-2 text-center">Luck Variance</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for analysis in banner_analysis %}
                        <tr class="border-b border-slate-700/50">
                            <td class="p-2 font-semibold">{{ analysis.banner_name }}</td>
                            <td class="p-2 text-center">{{ analysis.total_pulls }}</td>
                            <td class="p-2 text-center text-yellow-300 font-bold">{{ analysis.r3_count }}</td>
                            <td class="p-2 text-center">{{ analysis.gaps.min|default:"N/A" }}</td>
                            <td class="p-2 text-center">{{ analysis.gaps.max|default:"N/A" }}</td>
                            <td class="p-2 text-center">{{ analysis.gaps.avg|default:"N/A" }}</td>
                            <td class="p-2 text-center">{{ analysis.gaps.stdev|default:"N/A" }}</td>
                            <td class="p-2 text-center">{{ analysis.user_rate }}</td>
                            <td class="p-2 text-center">{{ analysis.banner_rate }}</td>
                            <!-- Conditionally color the luck variance for at-a-glance readability -->
                            <td class="p-2 text-center font-bold 
                                {% if analysis.luck_variance|slice:':1' == '+' %}text-green-400
                                {% elif analysis.luck_variance|slice:':1' == '-' %}text-red-400
                                {% else %}text-slate-400{% endif %}">
                                {{ analysis.luck_variance }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>

</div>

<!-- The script to initialize the chart -->
<script class="tab-js-script">
    (function() {

        // --- NEW: PODIUM TAB LOGIC ---
        const contentWrapper = document.querySelector('.tab-html-content');
        if (!contentWrapper) return;

        const rarityTabs = contentWrapper.querySelectorAll('.rarity-tab');
        const podiumContainer = contentWrapper.querySelector('#podium-content');
        let isLoadingPodium = false;

        async function loadPodiumContent(rarity) {
            if (isLoadingPodium) return;
            isLoadingPodium = true;

            // Update tab styles
            rarityTabs.forEach(tab => {
                if (tab.dataset.rarity == rarity) {
                    // tab.classList.add('bg-cyan-600', 'text-white');
                    // tab.classList.remove('bg-slate-700/50', 'text-slate-400');
                    tab.classList.add('bg-sky-800/80', 'border-slate-700', 'text-white', 'font-semibold');
                    tab.classList.remove('text-slate-400', 'hover:bg-slate-700/50');
                } else {
                    // tab.classList.remove('bg-cyan-600', 'text-white');
                    // tab.classList.add('bg-slate-700/50', 'text-slate-400');
                    tab.classList.remove('bg-sky-800/80', 'border-slate-700', 'text-white', 'font-semibold');
                    tab.classList.add('text-slate-400', 'hover:bg-slate-700/50');
                }
            });

            // Show loading state
            podiumContainer.style.opacity = 0.5;

            try {
                const response = await fetch(`/dashboard/top-students/${rarity}/`);
                if (!response.ok) throw new Error('Failed to load podium data.');
                podiumContainer.innerHTML = await response.text();
            } catch (error) {
                podiumContainer.innerHTML = `<p class="text-red-400">${error.message}</p>`;
            } finally {
                isLoadingPodium = false;
                podiumContainer.style.opacity = 1;
            }
        }

        // Attach listeners
        rarityTabs.forEach(tab => {
            tab.addEventListener('click', () => loadPodiumContent(tab.dataset.rarity));
        });

        // Set initial active state for the default (3-star) tab
        rarityTabs[0].click();

        // --- Include Chart.js library ---
        // We dynamically add the script to the page to ensure it's available.
        if (!document.getElementById('chartjs-script')) {
            const script = document.createElement('script');
            script.id = 'chartjs-script';
            script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
            document.head.appendChild(script);
        }

        const createChart = () => {
            const pieCtx = document.getElementById('rarityPieChart');
            if (pieCtx) {
                new Chart(pieCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['★★★', '★★', '★'],
                        datasets: [{
                            label: 'Pulls',
                            // These values are passed directly from the Django view.
                            data: [{{ r3_count|default:0 }}, {{ r2_count|default:0 }}, {{ r1_count|default:0 }}],
                            backgroundColor: [
                                'rgba(250, 204, 21, 0.7)',  // Yellow
                                'rgba(192, 132, 252, 0.7)', // Purple
                                'rgba(96, 165, 250, 0.7)'   // Blue
                            ],
                            borderColor: [
                                '#FBBF24',
                                '#C084FC',
                                '#60A5FA'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: '#cbd5e1' // slate-300
                                }
                            }
                        }
                    }
                });
            }

            // --- NEW: Banner Bar Chart ---
            const barCtx = document.getElementById('bannerBarChart');
            if (barCtx) {
                // Get the data passed from the Django view.
                const bannerData = {{ banner_distribution|safe }};
                
                new Chart(barCtx, {
                    type: 'bar', // A bar chart is better for many items.
                    data: {
                        labels: bannerData.map(item => item.banner_id__banner_name),
                        datasets: [{
                            label: 'Pulls',
                            data: bannerData.map(item => item.count),
                            backgroundColor: 'rgba(56, 189, 248, 0.7)', // Cyan
                            borderColor: '#38BDF8',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y', // Makes the bar chart horizontal - crucial for long labels.
                        responsive: true,
                        plugins: {
                            legend: { display: false }, // Hide the legend for a cleaner look.
                        },
                        scales: {
                            y: { ticks: { color: '#cbd5e1' } },
                            x: { ticks: { color: '#cbd5e1' } }
                        }
                    }
                });
            }

            // --- NEW: INTERACTIVE PER-BANNER DOUGHNUT CHART ---
            const perBannerCtx = document.getElementById('perBannerPieChart');
            const bannerSelect = document.getElementById('banner-select');
            
            if (perBannerCtx && bannerSelect) {
                // 1. Get the data passed from the Django view.
                const perBannerData = JSON.parse('{{ per_banner_rarity_json|escapejs|default:"{}" }}');
                let perBannerChart = null;

                // 2. This function updates the chart with new data.
                const updatePerBannerChart = (bannerName) => {
                    const data = perBannerData[bannerName];
                    if (!data) return;

                    if (perBannerChart) {
                        // If the chart exists, just update its data and redraw.
                        perBannerChart.data.datasets[0].data = [data.r3, data.r2, data.r1];
                        perBannerChart.update();
                    } else {
                        // If it's the first time, create the chart instance.
                        perBannerChart = new Chart(perBannerCtx, {
                            type: 'doughnut',
                            data: {
                                labels: ['★★★', '★★', '★'],
                                datasets: [{
                                    label: 'Pulls',
                                    data: [data.r3, data.r2, data.r1],
                                    backgroundColor: [
                                        'rgba(250, 204, 21, 0.7)',  // Yellow
                                        'rgba(192, 132, 252, 0.7)', // Purple
                                        'rgba(96, 165, 250, 0.7)'   // Blue
                                    ],
                                    borderColor: [
                                        '#FBBF24',
                                        '#C084FC',
                                        '#60A5FA'
                                    ],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                        labels: {
                                            color: '#cbd5e1' // slate-300
                                        }
                                    }
                                }
                            }
                        });
                    }
                };

                // 3. Attach an event listener to the dropdown.
                bannerSelect.addEventListener('change', (event) => {
                    updatePerBannerChart(event.target.value);
                });

                // 4. Initial draw: show the chart for the first banner in the list.
                if (bannerSelect.options.length > 0) {
                    updatePerBannerChart(bannerSelect.options[0].value);
                }
            }

            
        };
        
        // Wait for the Chart.js library to load before creating the chart.
        if (typeof Chart !== 'undefined') {
            createChart();
        } else {
            document.getElementById('chartjs-script').addEventListener('load', createChart);
        }
    })();
</script>