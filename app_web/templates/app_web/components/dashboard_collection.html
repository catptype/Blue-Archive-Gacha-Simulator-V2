<!-- app_web/components/_collection.html -->
<!-- This template is now a self-contained component with its own filtering logic. -->
{% load static %}

<div class="tab-html-content">
  <div class="flex flex-col sm:flex-row items-center justify-between mb-6 gap-4">
      <!-- MODIFIED: The counter is now static and rendered by Django -->
      <h2 id="collection-counter" class="text-xl font-semibold text-slate-300">
        Obtained ({{ obtained_count }} / {{ total_students }}) - {{ completion_percentage|floatformat:2 }}% Complete
      </h2>
      
      <!-- Filter Buttons -->
      <div class="flex items-center gap-2 p-1 bg-slate-700/50 rounded-lg">
        <button data-filter="all" class="filter-btn flex items-center gap-2 px-3 py-1 rounded-md text-sm font-semibold">
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
          <span>All</span>
        </button>
        <button data-filter="obtained" class="filter-btn flex items-center gap-2 px-3 py-1 rounded-md text-sm font-semibold">
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z M14 11V7a4 4 0 118 0" />
          </svg>
          <span>Obtained</span>
        </button>
        <button data-filter="not-obtained" class="filter-btn flex items-center gap-2 px-3 py-1 rounded-md text-sm font-semibold">
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
          <span>Not Obtained</span>
        </button>
      </div>
  </div>

  <!-- =============================================================== -->
  <!-- GROUPED STUDENT DISPLAY                                         -->
  <!-- =============================================================== -->
  {% regroup all_students by student_rarity as students_by_rarity %}

  <div class="flex flex-col gap-8">
      
      {% for rarity_group in students_by_rarity %}
          <div>
              <!-- Rarity Group Header -->
              <h3 class="text-2xl font-bold mb-4 flex items-center">
                  {% for i in "x"|rjust:rarity_group.grouper %}
                  <img src="{% static 'images/web/star_yellow.png' %}" alt="star" class="w-8 h-8">
                  {% endfor %}
              </h3>

              <!-- The grid container for the students in this rarity group. -->
              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                  
                  {% for student in rarity_group.list %}
                      <!-- 
                        THE FIX: The 'opacity' and 'grayscale' classes are REMOVED from this div.
                        The 'data-status' attribute remains for the filter to work.
                      -->
                      <div class="student-item relative" data-status="{% if student.is_obtained %}obtained{% else %}not-obtained{% endif %}">
                          
                          <!-- The student card is now always rendered at full opacity. -->
                          {% include 'app_web/components/student-card-static.html' with student=student %}
                          
                          <!-- 
                            THE FIX: The lock icon overlay is still present for un-obtained students.
                            It is NOT dimmed or grayscaled.
                          -->
                          {% if not student.is_obtained %}
                          <div class="absolute inset-0 w-[220px] aspect-[3.5/5] flex items-center justify-center bg-black/80 rounded-lg pointer-events-none">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-20 w-20 text-white" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" />
                              </svg>
                          </div>
                          {% endif %}
                      </div>
                  {% endfor %}
              </div>
          </div>
      {% endfor %}
  </div>
</div>

<!-- =============================================================== -->
<!-- THE SCRIPT IS NOW SEPARATED FOR EXECUTION BY EVAL()             -->
<!-- =============================================================== -->
<script class="tab-js-script">
    (function() {
        // Find elements within the currently loaded content.
        const contentWrapper = document.querySelector('.tab-html-content');

        console.log("contentWrapper", contentWrapper)
        if (!contentWrapper) return;

        const filterButtons = contentWrapper.querySelectorAll('.filter-btn');
        const studentItems = contentWrapper.querySelectorAll('.student-item');
        const totalStudents = studentItems.length;

        function filterCollection(filter) {
            let visibleCount = 0;

            filterButtons.forEach(btn => {
                if (btn.dataset.filter === filter) {
                    btn.classList.add('bg-cyan-600', 'text-white');
                    btn.classList.remove('text-slate-400', 'hover:bg-slate-600');
                } else {
                    btn.classList.add('text-slate-400', 'hover:bg-slate-600');
                    btn.classList.remove('bg-cyan-600', 'text-white');
                }
            });

            studentItems.forEach(item => {
                const status = item.dataset.status;
                const shouldShow = (filter === 'all' || filter === status);
                
                if (shouldShow) {
                    item.style.display = 'block';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });
        }

        filterButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                filterCollection(btn.dataset.filter);
            });
        });

        filterCollection('all'); // Set initial state
    })();
</script>