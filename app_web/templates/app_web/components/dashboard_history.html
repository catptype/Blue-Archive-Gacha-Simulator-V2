<!-- This template now contains the table, pagination controls, and its own script. -->

<!-- This div wraps all the visible HTML for parsing by eval(). -->
<div class="tab-html-content">
    
    <!-- This inner wrapper is the target for our AJAX content replacement. -->
    <div id="history-table-wrapper">
        <div class="overflow-x-auto">
            <table class="w-full text-left align-middle">
                <!-- MODIFIED: The header is now 4 columns -->
                <thead class="border-b border-slate-600 text-md text-slate-400">
                    <tr>
                        <th class="p-2 w-[20%]">Date</th>
                        <th class="p-2 w-[30%]">Banner</th>
                        <th class="p-2 w-[10%]">Rarity</th>
                        <th class="p-2 w-[40%]">Student</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tx in transactions_page %}
                    <tr class="border-b border-slate-700 
                        {% if tx.student_id.student_rarity == 3 %}text-white font-semibold bg-gradient-to-r from-pink-500/30 via-purple-500/30 to-cyan-500/30 font-semibold{% endif %}">
                        
                        <td class="p-2 text-slate-400">{{ tx.transaction_create_on|date:"Y-m-d H:i" }}</td>
                        
                        <td class="p-2">
                            <img src="{% url 'serve_banner_image' banner_id=tx.banner_id.banner_id %}" class="w-50 h-auto rounded-md object-cover">
                        </td>
                        
                        <!-- NEW: Rarity Column with stars -->
                        <td class="p-2 text-lg">
                            {% for i in "x"|rjust:tx.student_id.student_rarity %}<span>â˜…</span>{% endfor %}
                        </td>
                        
                        <!-- MODIFIED: Student Column now just has name and version -->
                        <td class="p-2 text-lg">
                            {{ tx.student_id.student_name }}
                            {% if tx.student_id.version != 'Original' %}
                                <span class="text-sm text-slate-400">({{ tx.student_id.version }})</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- =============================================================== -->
        <!-- NEW, UPGRADED PAGINATION CONTROLS                               -->
        <!-- =============================================================== -->
        <div class="flex items-center justify-between mt-4 text-sm text-slate-300">
            
            <!-- Group 1: First & Previous -->
            <div class="flex items-center gap-2">
                <a href="?page=1" 
                   class="page-link px-3 py-1 rounded-md 
                          {% if transactions_page.has_previous %}bg-slate-700 hover:bg-slate-600{% else %}bg-slate-800 text-slate-500 pointer-events-none{% endif %}">
                    &laquo; First
                </a>
                
                <!-- THE FIX: Use a more explicit 'if' condition for the href attribute -->
                <a href="{% if transactions_page.has_previous %}?page={{ transactions_page.previous_page_number }}{% else %}?page=1{% endif %}" 
                   class="page-link px-3 py-1 rounded-md 
                          {% if transactions_page.has_previous %}bg-slate-700 hover:bg-slate-600{% else %}bg-slate-800 text-slate-500 pointer-events-none{% endif %}">
                    Previous
                </a>
            </div>

            <!-- Group 2: Page Input & Go Button -->
            <form id="page-jump-form" class="flex items-center gap-2">
                <span>Page</span>
                <input type="number" id="page-input" 
                       class="w-16 h-8 text-center bg-slate-900 border border-slate-600 rounded-md" 
                       value="{{ transactions_page.number }}" 
                       min="1" max="{{ transactions_page.paginator.num_pages }}">
                <span>of {{ transactions_page.paginator.num_pages }}</span>
                <button type="submit" id="page-go-btn" class="px-3 py-1 bg-cyan-600 hover:bg-cyan-500 rounded-md font-semibold">Go</button>
            </form>

            <!-- Group 3: Next & Last -->
            <div class="flex items-center gap-2">
                <!-- THE FIX: Use a more explicit 'if' condition for the href attribute -->
                <a href="{% if transactions_page.has_next %}?page={{ transactions_page.next_page_number }}{% else %}?page={{ transactions_page.paginator.num_pages }}{% endif %}" 
                   class="page-link px-3 py-1 rounded-md 
                          {% if transactions_page.has_next %}bg-slate-700 hover:bg-slate-600{% else %}bg-slate-800 text-slate-500 pointer-events-none{% endif %}">
                    Next
                </a>
                <a href="?page={{ transactions_page.paginator.num_pages }}" 
                   class="page-link px-3 py-1 rounded-md 
                          {% if transactions_page.has_next %}bg-slate-700 hover:bg-slate-600{% else %}bg-slate-800 text-slate-500 pointer-events-none{% endif %}">
                    Last &raquo;
                </a>
            </div>
        </div>

    </div>
</div>

<!-- This script is separated and will be executed by eval() in the main dashboard page. -->
<script class="tab-js-script">
    (function() {
        // Find elements within the currently loaded content.
        const contentWrapper = document.querySelector('.tab-html-content');
        console.log("contentWrapper", contentWrapper)
        if (!contentWrapper) return;
        
        // This is the part of the content that WILL be replaced.
        const tableWrapper = contentWrapper.querySelector('#history-table-wrapper');
        const pageJumpForm = contentWrapper.querySelector('#page-jump-form');
        const pageInput = contentWrapper.querySelector('#page-input');

        /**
         * Fetches and replaces the table content for a given page URL.
         */
        async function fetchAndReplacePage(url) {
            if (!tableWrapper) return;
            tableWrapper.style.opacity = 0.5;
            try {
                const response = await fetch(`/dashboard/history${url}`);
                if (!response.ok) throw new Error('Failed to load page.');
                
                const responseText = await response.text();
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = responseText;
                
                const newTableWrapper = tempDiv.querySelector('#history-table-wrapper');

                if (newTableWrapper) {
                    // Replace the content of the old wrapper with the new content.
                    tableWrapper.innerHTML = newTableWrapper.innerHTML;
                }

            } catch (error) {
                tableWrapper.innerHTML = `<p class="text-red-400">${error.message}</p>`;
            } finally {
                tableWrapper.style.opacity = 1;
            }
        }

        // --- THE EVENT DELEGATION FIX ---
        // 1. Attach ONE click listener to the stable parent container.
        contentWrapper.addEventListener('click', (event) => {
            // 2. Check if the element that was actually clicked (or its parent) is a .page-link.
            //    '.closest()' is the perfect tool for this.
            const pageLink = event.target.closest('.page-link');

            // 3. If it's not a page link, do nothing.
            if (!pageLink) {
                return;
            }

            // 4. If it IS a page link, prevent the default refresh and load the content.
            event.preventDefault();
            const url = pageLink.getAttribute('href');
            fetchAndReplacePage(url);
        });

        // --- THE FIX: DELEGATED LISTENER 2: Handles the form 'submit' event ---
        contentWrapper.addEventListener('submit', (event) => {
            // Check if the event originated from our specific form.
            if (event.target.id === 'page-jump-form') {
                event.preventDefault(); // Stop the page reload.
                
                // Find the input within the form that was just submitted.
                const pageInput = event.target.querySelector('#page-input');
                if (pageInput) {
                    const pageNumber = pageInput.value;
                    const url = `?page=${pageNumber}`;
                    fetchAndReplacePage(url);
                }
            }
        });

        
        
    })();
</script>