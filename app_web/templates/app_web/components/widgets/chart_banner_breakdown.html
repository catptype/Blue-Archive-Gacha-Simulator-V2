<div class="relative p-4 bg-slate-700/50 rounded-lg">
    <h3 class="text-xl font-semibold mb-4">Banner Breakdown</h3>
    <div class="relative h-full">
        <canvas id="perBannerPieChart"></canvas>
    </div>
    
    <!-- The banner selector, positioned in the center -->
    <div class="absolute top-3/5 left-1/2 -translate-x-1/2 -translate-y-1/2 flex flex-col items-center">
        <label for="banner-select" class="text-xs text-slate-400">Select Banner</label>
        <select id="banner-select" class="bg-slate-800 border border-slate-600 rounded-md text-white p-1 text-sm">
            <!-- The options are now populated by the Django view -->
            {% for name in banner_names %}
                <option value="{{ name }}">{{ name }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<script class="tab-js-script">
    (function() {
        // Helper function to ensure Chart.js is loaded
        const whenChartJsReady = (callback) => {
            if (typeof Chart !== 'undefined') {
                callback();
            } else {
                let script = document.getElementById('chartjs-script');
                if (!script) {
                    script = document.createElement('script');
                    script.id = 'chartjs-script';
                    script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                    document.head.appendChild(script);
                }
                script.addEventListener('load', callback);
            }
        };

        const createBannerBreakdownChart = () => {
            const perBannerCtx = document.getElementById('perBannerPieChart');
            const bannerSelect = document.getElementById('banner-select');
            if (!perBannerCtx || !bannerSelect) return;

            // 1. Get the data passed from the Django view.
            const perBannerData = JSON.parse('{{ per_banner_rarity_json|escapejs|default:"{}" }}');
            let perBannerChart = null;

            // 2. This function updates the chart with new data.
            const updatePerBannerChart = (bannerName) => {
                const data = perBannerData[bannerName];
                if (!data) return;

                if (perBannerChart) {
                    // If the chart exists, just update its data and redraw.
                    perBannerChart.data.datasets[0].data = [data.r3, data.r2, data.r1];
                    perBannerChart.update();
                } else {
                    // If it's the first time, create the chart instance.
                    perBannerChart = new Chart(perBannerCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['★★★', '★★', '★'],
                            datasets: [{
                                label: 'Pulls',
                                data: [data.r3, data.r2, data.r1],
                                backgroundColor: [
                                    'rgba(250, 204, 21, 0.7)',  // Yellow
                                    'rgba(192, 132, 252, 0.7)', // Purple
                                    'rgba(96, 165, 250, 0.7)'   // Blue
                                ],
                                borderColor: [
                                    '#FBBF24',
                                    '#C084FC',
                                    '#60A5FA'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false, 
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        color: '#cbd5e1' // slate-300
                                    }
                                }
                            }
                        }
                    });
                }
            };

            // 3. Attach an event listener to the dropdown.
            bannerSelect.addEventListener('change', (event) => {
                updatePerBannerChart(event.target.value);
            });

            // 4. Initial draw for the first banner in the list.
            if (bannerSelect.options.length > 0) {
                updatePerBannerChart(bannerSelect.options[0].value);
            }
        };

        whenChartJsReady(createBannerBreakdownChart);
    })();
</script>