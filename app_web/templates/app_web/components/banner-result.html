<!-- This is the partial template for the results modal. -->
<div id="gacha-results-html-content">
  <div class="flex flex-col h-full">
      <!-- Modal Header -->
      <div class="flex-shrink-0 p-4 border-b border-slate-600">
          <h2 class="text-2xl font-bold text-cyan-300">Gacha Results</h2>
      </div>

      <!-- 
        This container now holds BOTH the desktop grid and the mobile slider.
        Responsive classes will toggle which one is visible.
      -->
      <div class="flex-grow p-4 overflow-hidden" style="perspective: 1000px;">
          
          <!-- =============================================================== -->
          <!-- 1. DESKTOP VIEW: GRID (Visible on 'xl' screens and up)         -->
          <!-- =============================================================== -->
          <div class="hidden xl:flex w-full h-full items-center justify-center">
            {% with num_students=pulled_students|length %}
            <div class="grid gap-4 grid-cols-1 xl:grid-cols-5">
                {% for student in pulled_students %}
                    <div class="{% if num_students == 1 %}xl:col-start-3{% endif %}">
                        {% include 'app_web/components/student-card.html' with student=student %}
                    </div>
                {% endfor %}
            </div>
            {% endwith %}
          </div>

          <!-- =============================================================== -->
          <!-- 2. MOBILE VIEW: SLIDER (Visible below 'xl' screens)           -->
          <!-- =============================================================== -->
          <!-- This entire section is hidden on desktop screens. -->
          <!-- MOBILE/TABLET VIEW: SLIDER -->
            <div id="mobile-gacha-slider" class="xl:hidden relative w-full h-full">
                <div class="slider-track absolute top-0 left-0 h-full w-full flex items-center transition-transform duration-500 ease-in-out">
                    {% for student in pulled_students %}
                    <div class="slider-slide relative w-full h-full flex-shrink-0 flex items-center justify-center">
                        <div class="w-64">
                            {% include 'app_web/components/student-card.html' with student=student %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                {% if pulled_students|length > 1 %}
                <!-- MODIFIED: Navigation buttons are now larger and spaced from the edge -->
                <button class="mobile-nav-arrow mobile-nav-left absolute left-2 top-1/2 -translate-y-1/2 bg-black/40 p-4 rounded-full hover:bg-sky-500/50 transition-colors z-40">
                    <svg class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <button class="mobile-nav-arrow mobile-nav-right absolute right-2 top-1/2 -translate-y-1/2 bg-black/40 p-4 rounded-full hover:bg-sky-500/50 transition-colors z-40">
                    <svg class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>

                <div class="mobile-indicator-dots absolute bottom-2 left-1/2 -translate-x-1/2 flex gap-2">
                    {% for student in pulled_students %}
                    <div class="dot w-2 h-2 bg-white/30 rounded-full transition-colors duration-300"></div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
      </div>

    {% if pulled_students|length > 1 %}
    <button id="reveal-all-btn" class="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white font-semibold rounded-lg transition-colors">
        Reveal All
    </button>
    {% endif %}
  </div>
</div>

<!-- This self-contained script powers the new mobile slider -->
<script id="gacha-results-js-script">
    (function() {

        // --- =============================================================== ---
        // --- MODULE 1: MOBILE SLIDER LOGIC                                 ---
        // --- =============================================================== ---
        // This logic is now wrapped in its own function for clean separation.
        function initializeMobileSlider() {
            const slider = document.getElementById('mobile-gacha-slider');
            // If the slider doesn't exist (e.g., on desktop), exit this specific function.
            if (!slider) return; 

            const track = slider.querySelector('.slider-track');
            const slides = slider.querySelectorAll('.slider-slide');
            const totalSlides = slides.length;
            
            // This guard clause is now SAFE. It only stops the slider setup,
            // not the entire script.
            if (totalSlides <= 1) return;

            const prevBtn = slider.querySelector('.mobile-nav-left');
            const nextBtn = slider.querySelector('.mobile-nav-right');
            const dots = slider.querySelectorAll('.dot');
            let currentIndex = 0;

            function updateSlider() {
                // Move the track to show the correct slide
                track.style.transform = `translateX(-${currentIndex * 100}%)`;

                // Update indicator dots
                dots.forEach((dot, index) => {
                    if (index === currentIndex) {
                        dot.classList.add('bg-white');
                        dot.classList.remove('bg-white/30');
                    } else {
                        dot.classList.remove('bg-white');
                        dot.classList.add('bg-white/30');
                    }
                });

                // Show/hide arrows at the ends
                prevBtn.style.display = (currentIndex === 0) ? 'none' : 'block';
                nextBtn.style.display = (currentIndex === totalSlides - 1) ? 'none' : 'block';
            }

            nextBtn.addEventListener('click', () => {
                if (currentIndex < totalSlides - 1) {
                    currentIndex++;
                    updateSlider();
                }
            });

            prevBtn.addEventListener('click', () => {
                if (currentIndex > 0) {
                    currentIndex--;
                    updateSlider();
                }
            });
            
            updateSlider();
        }

        // --- =============================================================== ---
        // --- MODULE 2: CARD FLIPPING LOGIC                                 ---
        // --- =============================================================== ---
        // This logic is now also in its own function and will ALWAYS run.
        function initializeCardFlipping() {
            const allFlippableCards = document.querySelectorAll('.student-card-flipper');
            const revealAllButton = document.getElementById('reveal-all-btn');

            /**
             * NEW: A "smart" random position generator using Grid Partitioning.
             * This ensures sparkles are scattered and never too close.
             * @param {number} count - The number of positions to generate.
             * @returns {Array<Object>} An array of {top, left} percentage positions.
             */
            function generateSparklePositions(count = 5) {
                const positions = [];
                const gridCols = 2;
                const gridRows = 2;
                const totalCells = gridCols * gridRows;

                // 1. Create a list of all possible grid cell indices (0 to 8).
                let cellIndices = Array.from(Array(totalCells).keys());

                // 2. Shuffle the list of indices to pick random cells.
                for (let i = cellIndices.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [cellIndices[i], cellIndices[j]] = [cellIndices[j], cellIndices[i]];
                }

                // 3. Take the first 'count' of the shuffled indices.
                const chosenCells = cellIndices.slice(0, count);

                // 4. For each chosen cell, generate a random position ("jitter") within it.
                chosenCells.forEach(cellIndex => {
                    const col = cellIndex % gridCols;
                    const row = Math.floor(cellIndex / gridCols);

                    // Calculate a random position inside the cell, avoiding the very edges.
                    const jitterX = (Math.random() * 0.6 + 0.2) * (100 / gridCols); // Jitter between 20% and 80% of cell width
                    const jitterY = (Math.random() * 0.6 + 0.2) * (100 / gridRows); // Jitter between 20% and 80% of cell height
                    
                    positions.push({
                        left: (col * (100 / gridCols)) + jitterX,
                        top: (row * (100 / gridRows)) + jitterY,
                    });
                });

                return positions;
            }

            const revealCard = (cardElement) => {
                const innerCard = cardElement.querySelector('.relative.w-full.h-full');
                if (innerCard.classList.contains('is-flipped')) return;

                const rarity = parseInt(cardElement.dataset.rarity, 10);
                
                innerCard.classList.add('is-flipped');
                
                if (rarity === 3) {
                    innerCard.style.transform = 'rotateY(180deg) scale(0.95)';
                    
                    // --- MODIFIED: Use the new "smart" position generator ---
                    setTimeout(() => {
                        const sparkles = cardElement.querySelectorAll('.sparkle');
                        const sparklePositions = generateSparklePositions(sparkles.length);

                        sparkles.forEach((sparkle, index) => {
                            // Apply the generated position to each sparkle.
                            sparkle.style.top = `${sparklePositions[index].top}%`;
                            sparkle.style.left = `${sparklePositions[index].left}%`;

                            // The rest of the animation logic is unchanged.
                            setTimeout(() => {
                                sparkle.classList.add('animate');
                                setTimeout(() => {
                                    sparkle.classList.add('fade');
                                }, 500);
                            }, index * 100);
                        });
                    }, 800);

                } else {
                    innerCard.style.transform = 'rotateY(180deg)';
                }
            };

            // --- Event Listeners (Unchanged) ---
            allFlippableCards.forEach(card => {
                card.addEventListener('click', () => revealCard(card), { once: true });
            });

            if (revealAllButton) {
                revealAllButton.addEventListener('click', () => {
                    allFlippableCards.forEach((card, index) => {
                        setTimeout(() => {
                            revealCard(card);
                        }, index * 75);
                    });
                    // revealAllButton.style.display = 'none';
                }, { once: true });
            }
        }

        // --- =============================================================== ---
        // --- EXECUTION                                                     ---
        // --- =============================================================== ---
        // Now, we call both initialization functions independently.
        initializeMobileSlider();
        initializeCardFlipping();

    })(); // The IIFE now safely contains both modules.
</script>